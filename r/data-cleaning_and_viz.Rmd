---
title: "Data Cleaning"
author: "Clarissa Boyajian and Halina Do-Linh"
date: "1/24/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(here)
library(janitor)
library(tidycensus)
library(sf)
library(lubridate)
library(tmap)
library(patchwork)

options(scipen = 999)

# file path from .Rproj to outdoorequity shared folder
outdoorequity_folder_file_path <- here::here("../../../../capstone/outdoorequity/")
```

# Bring in geometries

```{r}
# CA county geometries
ca_county_geom <- st_read(paste0(outdoorequity_folder_file_path, "../../../../capstone/outdoorequity/data/ca_county_geometries/counties.shp")) %>% 
  clean_names() %>% 
  rename(county_name = name)
st_crs(ca_county_geom) <- 4326
```


# Bring in RIDB Data

## Set up

```{r}
# read in functions created in R script
source("functions/function_data-subsetting-pre2018.R")
source("functions/function_data-subsetting-post2019.R")
```

```{r}
# 2018
RIDB_cleaning_pre2018(full_file_path = paste0(outdoorequity_folder_file_path, 
                                              "data/reservations2018.csv"), 
                      state_abbrev = "CA", df_name = "ridb_2018")

ridb_2018 <- ridb_2018 %>% 
    mutate(start_date = as.Date(start_date),
           end_date = as.Date(end_date),
           order_date = as.Date(order_date))
```

## Standardizing values

Notes on standardizations to consider:
- region description: 
    - change "-FS" and "- FS" to "Forest Service"
    - add indicator to regions without (i.e. not USFS or NPS)
- parent location:
    - change "-FS" and "- FS" to "Forest Service"
    - change "NF" to "National Forest"
    - change "PWR" to "Pacific West Region"
- park:
    - remove "--- #idcodehere#", and " (CA)" from ends of park names
    - fix anomolies that don't follow pattern (i.e. "region / campground name" or "campground name, region")
    - remove all uppercase
- facility zip:
    - remove everything after 5th digit
- start date:
    - min: 2017-06-19
    - max: 2019-09-30
- end date:
    - min: 2017-06-22
    - max: 2019-10-14
- order date: **the data is split by fiscal year of order date!!**
    - min: 2017-10-01
    - max: 2018-09-30

NAs:
    - facility zip: 108309



## Calculated Variables

Issues to consider: 
- length of stay goes to -126
- highest price / person is $279 for a group campsite

```{r}
ridb_2018 <- ridb_2018 %>% 
    st_as_sf(coords = c("facility_longitude", "facility_latitude"),
             crs = 4326) %>% 
    mutate(length_of_stay = as.numeric(difftime(end_date, start_date), units = "days"), # range: 1 - 22
           booking_window = as.numeric(difftime(start_date, order_date), units = "days"), # range: -126 - 662
           cost_per_visitor_per_day = (total_paid / number_of_people) / length_of_stay # range: $0 - $279, (48 rows are Inf because # people = 0)
           )
```

## Summarized variables

Aggregate (mean) to reservable site level
```{r}
ridb_2018_site_summary <- 
    ridb_2018 %>% 
    filter(cost_per_visitor_per_day != "Inf") %>% #drop 48 rows with "Inf" for cost/visitor/day
    group_by(park) %>% 
    summarize(average_paid = mean(total_paid),
              max_paid = max(total_paid),
              min_paid = min(total_paid),
              average_number_of_people = mean(number_of_people),
              max_number_of_people = max(number_of_people),
              min_number_of_people = min(number_of_people),
              average_length_of_stay = mean(length_of_stay),
              max_length_of_stay = max(length_of_stay),
              min_length_of_stay = min(length_of_stay),
              average_booking_window = mean(booking_window),
              max_booking_window = max(booking_window),
              min_booking_window = min(booking_window),
              average_cost_per_visitor_per_dady = mean(cost_per_visitor_per_day),
              max_cost_per_visitor_per_day = max(cost_per_visitor_per_day),
              min_cost_per_visitor_per_day = min(cost_per_visitor_per_day),
              count = n())
```

Aggregate (mean) to agency level
```{r}
ridb_2018_agency_summary <- 
    ridb_2018 %>% 
    filter(cost_per_visitor_per_day != "Inf") %>% #drop 48 rows with "Inf" for cost/visitor/day
    group_by(agency) %>% 
    summarize(average_paid = mean(total_paid),
              max_paid = max(total_paid),
              min_paid = min(total_paid),
              average_number_of_people = mean(number_of_people),
              max_number_of_people = max(number_of_people),
              min_number_of_people = min(number_of_people),
              average_length_of_stay = mean(length_of_stay),
              max_length_of_stay = max(length_of_stay),
              min_length_of_stay = min(length_of_stay),
              average_booking_window = mean(booking_window),
              max_booking_window = max(booking_window),
              min_booking_window = min(booking_window),
              average_cost_per_visitor_per_day = mean(cost_per_visitor_per_day),
              max_cost_per_visitor_per_day = max(cost_per_visitor_per_day),
              min_cost_per_visitor_per_day = min(cost_per_visitor_per_day),
              count = n())
```


# Bring in Census Data

## Set up

```{r message=FALSE}
# #ONLY HAVE TO RUN THE FIRST TIME USING THIS RMD
# census_api <- source("api_keys/census_api_key.R")
# census_api_key(key = census_api[[1]], install = TRUE, overwrite = TRUE)
# readRenviron("~/.Renviron")

# acs5_variables <- load_variables(year = 2018, dataset = "acs5")

# set up what to load
acs_geography <- "zcta"
acs_year <- 2018
```

```{r}
## RACE ##
acs_2018_race <- 
    get_acs(geography = acs_geography,
            year = acs_year,
            summary_var = "B02001_001", #Estimate!!Total:
            variables = c(
                white = "B02001_002", # Estimate!!Total:!!White alone (INCLUDING HISPANIC OR LATINO)
                black = "B02001_003", # Estimate!!Total:!!Black or African American alone
                native_american = "B02001_004", # Estimate!!Total:!!American Indian and Alaska Native alone
                asian = "B02001_005", # Estimate!!Total:!!Asian alone
                pacific_islander = "B02001_006", # Estimate!!Total:!!Native Hawaiian and Other Pacific Islander alone
                other = "B02001_007", # Estimate!!Total:!!Some other race alone
                multiracial = "B02001_008" # Estimate!!Total:!!Two or more races
            )) %>% 
    clean_names() %>% 
    mutate(zip_code = str_sub(name, start = -5, end = -1)) %>% 
    rename(race = variable)
```

```{r}
## MEANS OF TRANSPORTATION TO WORK BY VEHICLES AVAILABLE ##
acs_2018_transportation <- 
  get_acs(geography = acs_geography,
          year = acs_year,
          summary_var = "B08141_001", #Estimate!!Total:
          variables = c(
            no_vehicle = "B08141_002" # Estimate!!Total:!!No vehicle available
          )) %>% 
  clean_names()

## EDUCATIONAL ATTAINMENT FOR THE POPULATION 25 YEARS AND OVER ##
acs_2018_education <- 
  get_acs(geography = acs_geography,
          year = acs_year,
          summary_var = "B15003_001", # Estimate!!Total:
          variables = c(
            "B15003_002", "B15003_003",  "B15003_004", "B15003_005", 
            "B15003_006", "B15003_007", "B15003_008", "B15003_009",
            "B15003_010", "B15003_011", "B15003_012", "B15003_013",
            "B15003_014", "B15003_015", "B15003_016", "B15003_017",
            "B15003_018", # Estimate!!Total:!!GED or alternative credential or below (including above)
            "B15003_019", "B15003_020", # Estimate!!Total:!!Some college
            "B15003_021", "B15003_022", # Estimate!!Total:!!Associates or bachelors degree
            "B15003_023", "B15003_024", "B15003_025" # Estimate!!Total:!!Masters degree and above
          )) %>% 
  clean_names()

## HOUSEHOLD INCOME IN THE PAST 12 MONTHS (IN 2019 INFLATION-ADJUSTED DOLLARS) ##
acs_2018_total_income <- 
  get_acs(geography = "zcta",
          year = acs_year,
          summary_var = "B19001_001", # Estimate!!Total:
          variables = c(
            "B19001_002", # Estimate!!Total:!!Less than $10,00 (spread of ranges change from -002 to -0017)
            "B19001_017" # Estimate!!Total:!!$200,000 or more
          )) %>% 
  clean_names()
```

```{r}
## MEDIAN HOUSEHOLD INCOME IN THE PAST 12 MONTHS (IN 2019 INFLATION-ADJUSTED DOLLARS) ##
acs_2018_median_income <- 
  get_acs(geography = acs_geography,
          year = acs_year,
          variables = c(
            median_income = "B19013_001" # Estimate!!Median household income in the past 12 months (in 2019 inflation-adjusted dollars)
          )) %>% 
  clean_names() %>% 
  mutate(zip_code = str_sub(name, start = -5, end = -1)) %>% 
  rename(median_income = estimate) %>% 
  select(median_income, zip_code)
  
```

```{r}
## PER CAPITA INCOME IN THE PAST 12 MONTHS (IN 2019 INFLATION-ADJUSTED DOLLARS) ##
acs_2018_percapita_income <- 
  get_acs(geography = acs_geography,
          year = acs_year,
          variables = c(                        
            "B19301_001" # Estimate!!Per capita income in the past 12 months (in 2019 inflation-adjusted dollars)
          )) %>% 
  clean_names()
## LANGUAGE SPOKEN AT HOME BY ABILITY TO SPEAK ENGLISH FOR THE POPULATION 5 YEARS AND OVER ##
                        # long list found here (https://data.census.gov/cedsci/table?d=ACS%205-Year%20Estimates%20Detailed%20Tables&tid=ACSDT5Y2019.B16001)
##THINK ABOUT ADDING:
#B05001 # citizenship status

## use "geometry = TRUE" within `get_acs()` function to get geometries for areas
```


## Calculating socioeconomic demographics

```{r}
# calculate percentage
acs_2018_race_stats <- 
    acs_2018_race %>% 
    group_by(zip_code, race) %>% 
    summarise(percent = estimate / summary_est)

# create columnn for each group
acs_2018_race_zip_percent <- 
    acs_2018_race_stats %>% 
    pivot_wider(names_from = "race",
                values_from = "percent")
    
```


# Combine RIDB and Census

```{r}
combined_data_2018_ridb_acs <- 
  left_join(x = ridb_2018,
            y = acs_2018_race_zip_percent,
            by = c("customer_zip" = "zip_code")) %>% 
  mutate(non_white = 1 - white, .before = geometry) %>% 
  left_join(y = acs_2018_median_income,
            by = c("customer_zip" = "zip_code"))
```




# Visualization

### Reservation viz

```{r}
ggplot(data = ridb_2018) +
    geom_histogram(aes(x = length_of_stay), fill = "goldenrod") +
    labs(x = "Lenth of stay (days)",
         y = "Individual Reservations") +
    theme_minimal()
```

NOTES for graph below: 
- `r `nrow(ridb_2018 %>% filter(booking_window < 0)) / nrow(ridb_2018)` of data > 0 (~1%)
```{r}
plot_histogram_booking_window <- 
    ggplot(data = ridb_2018, 
           aes(x = booking_window)) +
    geom_histogram(fill = "goldenrod", binwidth = 10) +
    labs(y = "Count of Individual Visits",
         x = "Days elapsed from order to visit",
         title = "Booking Window Length \nfor Reservable Overnight Sites in California in 2018") +
    theme_minimal() +
    theme(panel.grid.minor.x = element_blank()) +
    scale_x_continuous(limits = c(0, 510), breaks = seq(0, 510, by = 30)) +
    scale_y_continuous(limits = c(0, 100000), breaks = seq(0, 100000, by = 20000)) +
    geom_vline(xintercept = 180, linetype = "dashed", size = .3, alpha = .5) +
    annotate("text", x = 210, y = 90900, label = "6 months") +
    geom_vline(xintercept = 360, linetype = "dashed", size = .3, alpha = .5) +
    annotate("text", x = 380, y = 90900, label = "1 year")

plot_histogram_booking_window
```

```{r, eval=FALSE}
ggsave(plot = plot_histogram_booking_window, 
       filename = "../figs/2018_histogram_booking_window.png",
       width = 14,
       height = 7)
```


### Reservable Site viz

NOTES for graph below: 
- Removed `r 16661 / nrow(combined_data_2018_ridb_acs)` (~3%)
```{r}
plot_asian <- 
  ggplot(combined_data_2018_ridb_acs %>% filter(asian > .1)) +
  geom_histogram(aes(x = asian), fill = "darkgreen") +
  scale_y_continuous(limits = c(0, 50000)) +
  labs(x = "Proportion of Home ZIP",
       y = "Number of Reservations",
       title = "Asian")

plot_black <- 
  ggplot(combined_data_2018_ridb_acs %>% filter(black > .1)) +
  geom_histogram(aes(x = black), fill = "darkblue") +
  scale_y_continuous(limits = c(0, 45000)) +
  labs(x = "Proportion of Home ZIP",
       y = "Number of Reservations",
       title = "Black")

plot_multiracial <- 
  ggplot(combined_data_2018_ridb_acs %>% filter(multiracial > .1)) +
  geom_histogram(aes(x = multiracial), fill = "darkred") +
  scale_y_continuous(limits = c(0, 45000)) +
  labs(x = "Proportion of Home ZIP",
       y = "Number of Reservations",
       title = "Multiracial")

plot_native_american <- 
  ggplot(combined_data_2018_ridb_acs %>% filter(native_american > .1)) +
  geom_histogram(aes(x = native_american), fill = "darkblue") +
  scale_y_continuous(limits = c(0, 45000)) +
  labs(x = "Proportion of Home ZIP",
       y = "Number of Reservations",
       title = "Native American")

plot_pacific_islander <- 
  ggplot(combined_data_2018_ridb_acs %>% filter(pacific_islander > .1)) +
  geom_histogram(aes(x = pacific_islander), fill = "darkblue") +
  scale_y_continuous(limits = c(0, 45000)) +
  labs(x = "Proportion of Home ZIP",
       y = "Number of Reservations",
       title = "Hawaiian and Other Pacific Islander")

plot_other <- 
  ggplot(combined_data_2018_ridb_acs %>% filter(other > .1)) +
  geom_histogram(aes(x = other), fill = "darkblue") +
  scale_y_continuous(limits = c(0, 45000)) +
  labs(x = "Proportion of Home ZIP",
       y = "Number of Reservations",
       title = "Other")

plot_white_hispanic_latinx <- 
  ggplot(combined_data_2018_ridb_acs %>% filter(white > .1)) +
  geom_histogram(aes(x = white), fill = "goldenrod") +
  scale_y_continuous(limits = c(0, 45000)) +
  labs(x = "Proportion of Home ZIP",
       y = "Number of Reservations",
       title = "White and Hispanic/Latinx")


plots_race_cost_pervisitor_perday <- (plot_asian + plot_black + plot_white_hispanic_latinx) / 
  (plot_native_american + plot_other + plot_multiracial) #+ 
  #plot_annotation(title = "Daily Cost per Visitor Compared to Racial Breakdown of Home ZIP Code \nfor Reservable Overnight Sites in California in 2018")

plots_race_cost_pervisitor_perday
```


```{r}
plot_bor <- 
  ggplot(combined_data_2018_ridb_acs %>% filter(agency == "BOR")) +
  geom_bar(aes(x = length_of_stay), fill = "darkblue")

plot_nps <- 
  ggplot(combined_data_2018_ridb_acs %>% filter(agency == "NPS")) +
  geom_bar(aes(x = length_of_stay), fill = "darkgreen")

plot_usfs <- 
  ggplot(combined_data_2018_ridb_acs %>% filter(agency == "USFS")) +
  geom_bar(aes(x = length_of_stay), fill = "darkred")

plot_usace <- 
  ggplot(combined_data_2018_ridb_acs %>% filter(agency == "USACE")) +
  geom_bar(aes(x = length_of_stay), fill = "goldenrod")

(plot_nps + plot_bor) / (plot_usfs + plot_usace)
```



```{r, eval=FALSE}
ggsave(plot = plots_race_cost_pervisitor_perday, 
       filename = "../figs/2018_scatter_race_cost_pervisitor_perday.png",
       width = 11,
       height = 7)
```




### Agency viz

```{r}
# reservations per agency
ggplot(data = ridb_2018) +
  geom_histogram(aes(x = agency, fill = agency), stat = "count") +
  scale_fill_discrete(labels = c("Bureau of Reclamation", "National Park Service", 
                                 "US Army Corps of Engineers", "US Foreset Service")) +
  theme_minimal() +
  labs(x = "Agency",
       y = "Number of Reservations",
       fill = "Agency",
       title = "Total Reservations at Federal Public Land Management Agency \nfor Reservable Overnight Sites in California in 2018")
```

```{r}
plot_bar_length_of_stay <- 
  ggplot(combined_data_2018_ridb_acs %>% filter(agency == "BOR")) +
  geom_bar(aes(x = length_of_stay), fill = "darkblue")
```

```{r, eval=FALSE}
ggsave(plot = plot_jitter_violin_agency_length_of_stay,
       filename = "../figs/2018_jitter_violin_length_of_stay.png",
       width = 14,
       height = 7)
```




