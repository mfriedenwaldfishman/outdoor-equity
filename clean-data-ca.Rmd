---
title: "Clean Data CA"
author: "Halina Do-Linh"
date: "1/23/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# attached packages
library(tidyverse)
library(janitor)
library(here)
```

# Read in yearly reservation datasets

```{r}
ridb_2020 <- read_csv(here("data", "FY20-historical-reservations-full.csv"))
ridb_2019 <- read_csv(here("data", "reservations2019.csv"))
ridb_2018 <- read_csv(here("data", "reservations2018.csv"))
ridb_2017 <- read_csv(here("data", "2017.csv"))
```

# Tidy variables for all years

```{r}
select_columns <- c("historicalreservationid",
         "ordernumber",
         "agency",
         "orgid",
         "regioncode", "regiondescription",
         "parentlocationid", "parentlocation",
         "sitetype", "usetype",
         "productid", 
         "inventorytype", 
         "facilityid", "facilityzip", "facilitystate", "facilitylongitude", "facilitylatitude",
         "customerzip", 
         "totalbeforetax", "discount", "totalpaid",
         "startdate", "enddate", "orderdate",
         "numberofpeople")

rm_sitetype <- c("historic tour",
                 "hiking zone",
                 "group picnic area",
                 "cave tour",
                 "management",
                 "anchorage",
                 "picnic",
                 "entry point",
                 "trailhead")
```

# Tidy 2017 Data

```{r}
# column names with underscores
ridb_2017_clean <- ridb_2017 %>% 
  janitor::clean_names() %>% 
  select(select_columns) %>% 
  filter(facilitystate == "California") %>% 
  mutate(sitetype = tolower(sitetype)) %>% 
  filter(sitetype != rm_sitetype) %>% 
  filter(usetype == "Overnight") %>%
  filter(customerzip == str_extract_all(customerzip,"[[:digit:]]{5}"))
```



# Tidy 2018 Data

- because of how the raw column names are we are getting two versions of clean names: one with and one without underscores.

```{r}
# column names with underscores
ridb_2018_clean <- ridb_2018 %>% 
  janitor::clean_names() %>% 
  select(select_columns) %>% 
  filter(facilitystate == "California") %>% 
  mutate(sitetype = tolower(sitetype)) %>% 
  filter(sitetype != rm_sitetype) %>% 
  filter(usetype == "Overnight") %>%
  filter(customerzip == str_extract_all(customerzip,"[[:digit:]]{5}"))
```


# Tidy 2019 Data

```{r}
ridb_2019_clean <- ridb_2019 %>% 
  janitor::clean_names() %>% 
  select(select_columns) %>% 
  filter(facilitystate == "California") %>% 
  mutate(sitetype = tolower(sitetype)) %>% 
  filter(sitetype != rm_sitetype) %>% 
  filter(usetype == "Overnight") %>%
  filter(customerzip == str_extract_all(customerzip,"[[:digit:]]{5}"))
```

- 2019 ridb clean had to remove `nights` column does not exist

# Tidy 2020 Data (OG Cleaning)

```{r}
ridb_2020_clean <- ridb_2020 %>% 
  janitor::clean_names() %>% 
  select("historicalreservationid",
         "ordernumber",
         "agency",
         "orgid",
         "regioncode", "regiondescription",
         "parentlocationid", "parentlocation",
         "sitetype", "usetype",
         "productid", "inventorytype", 
         "facilityid", "facilityzip", "facilitystate", "facilitylongitude", "facilitylatitude",
         "customerzip", 
         "totalbeforetax",
         "discount", "totalpaid",
         "startdate", "enddate", "orderdate",
         "nights",
         "numberofpeople") %>% 
  filter(facilitystate == "California") %>% 
  mutate(sitetype = tolower(sitetype)) %>% 
  filter(sitetype != c("historic tour",
                      "hiking zone",
                      "group picnic area",
                      "cave tour",
                      "management",
                      "anchorage",
                      "picnic",
                      "entry point",
                      "trailhead")) %>% 
  filter(usetype == "Overnight") %>% 
  mutate(nights = gsub(" days", "", nights)) %>% # used tidyverse gsub to remove day and days
  mutate(nights = as.numeric(gsub(" day", "", nights))) %>% # make the column numeric instead of chr
  filter(customerzip == str_extract_all(customerzip,"[[:digit:]]{5}"))

```

# Other cleaning functions

- used `get_dupes()` to confirm that there are no duplicate rows within `historicalreservationid`
- 2020 clean data has no dupes!
- 2019 clean data has potentially 299,247 dupes...

```{r}
janitor::get_dupes(ridb_2019_clean, historicalreservationid)
```

```{r}
ridb_2019_dupes <- ridb_2019_clean %>% 
  filter(historicalreservationid == "000103ba-6b5a-5a30-a17e-0bf8ada0dbdf")
```


At this point:

- `sitetype`: 
"standard nonelectric"
"group walk to"                   
"walk to"                         
"group standard area nonelectric"  
"group standard nonelectric"      
"tent only nonelectric"            
"group tent only area nonelectric"
‚Äùgroup shelter nonelectric"       
"rv nonelectric"                                        
"tent only electric"                                       
"standard electric"                
"cabin nonelectric"               
"group equestrian"                 
"boat in"                         
"group hike to"                    
"hike to"                         
"rv electric"                      
"cabin electric"                  
"equestrian nonelectric"          
"group standard electric"          
"group standard area electric"    
"yurt"                            
"group rv area nonelectric"        
"shelter nonelectric"
- `sitetype` removed: "group shelter electric", "destination zone", NAs
- `usetype` is only "Overnight"
- `inventorytype` is only "CAMPING"
- `nights` is numeric and removed " day" and " days". When changed to numeric NAs were introduced by coercion. I think this came up because there were some 00:00:00 values and these can't numeric.
- `startdate`, `enddate`, `orderdate` classes are "POSIXct" or "POSIXt" 
- `customerzip` now only contains zip codes with 5 digit numbers; class is character

