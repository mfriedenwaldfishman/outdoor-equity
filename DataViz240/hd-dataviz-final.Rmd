---
title: "Data Viz: Final Project"
author: "Halina Do-Linh"
date: "3/8/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(here)
library(janitor)
library(tidycensus)
library(tmap)
library(sf)
```

```{r}
# load data
data_combined_2018 <- read.csv("../../../data_clean/2018_joined_data.csv")
```


```{r}
# set up data
data_combined_2018_clean <- 
  data_combined_2018 %>% 
  group_by(park, agency) %>%
  summarize(median_median_income = median(median_income, na.rm = TRUE),
            mean_median_income = round(mean(median_income, na.rm = TRUE), 0),
            max_median_income = max(median_income, na.rm = TRUE),
            min_median_income = min(median_income, na.rm = TRUE),
            facility_latitude = mean(facility_latitude),
            facility_longitude = mean(facility_longitude),
            count = n()) %>% 
  st_as_sf(coords = c("facility_longitude","facility_latitude"), crs = 4326) # lat lon columns are removed and values are moved into geometry column
```

## write `data_combined_2018_clean` as a csv
```{r}
# save as an RDS next time
saveRDS(data_combined_2018_clean, "/capstone/outdoorequity/halina/outdoor-equity/shiny/outdoor-equity-app/data_resMedIncome_CAmap_2018.rds")
```


## write `zip_geometries_ca` as a csv
```{r}
saveRDS(zip_geometries_ca, "/capstone/outdoorequity/halina/outdoor-equity/shiny/outdoor-equity-app/data_zip_geometries_ca.rds")
```


```{r}
# pull in acs CA county data
zip_geometries_ca <- get_acs(geography = "state", year = 2018, geometry = TRUE, 
                             state = "California",
                             summary_var = "B01001_001",
                             variables = c(male = "B01001_002")) %>% 
  select(NAME, geometry)
  
zip_geometries_ca_clean <- zip_geometries_ca %>% 
  mutate(county = str_extract(NAME, "(\\w)([:punct:])"))
  # select(zip_code, geometry)

```

# Map

Pull in median household income for 2018

## histogram of median median income
```{r}
ggplot(data = data_combined_2018_clean, aes(x = median_median_income)) +
  geom_histogram()
```

## histogram of mean median income
```{r}
ggplot(data = data_combined_2018_clean, aes(x = mean_median_income)) +
  geom_histogram()
```

## map of median median income at park sites
```{r}
# add explanatory text about median household income for US
tmap_mode("view") # plot
tm_shape(zip_geometries_ca) +
  tm_polygons(interactive = FALSE) + # this layer doesn't need to be interactive and this removes the popup vars
tm_shape(data_combined_2018_clean) +
  tm_view(view.legend.position = c("bottom", "right")) + # doesn't work for interactive maps??
  tm_symbols(size = "count",
             col = "mean_median_income",
             alpha = 0.8,
             title.col = "Estimated Household Income of Visitor ZIP Code",
             style = "jenks",
             palette = "viridis",
             popup.vars = c("Agency" = "agency",
                            "Number of Reservations" = "count", 
                            "Estimated Household Income" = "mean_median_income"))
             # legend.hist = TRUE) can't use histogram for interactive map
  

## OLD CODE ##
  # tm_shape(shapefile_with_MNO_data) + 
  # tm_dots("MNO_variable")
  # tm_fill(col = "number_reservations",
  #         palette = "PuRd",
  #         style = "jenks",
  #         n = 10)
  # tm_layout(title = "Median Income of Visitors' Home ZIP at Reservable Sites in CA",
  #           legend.position = c("left", "bottom"))
             # breaks = c(40000, 50000, 60000, 70000, 80000, 90000, 100000, 150000, 200000),
```

