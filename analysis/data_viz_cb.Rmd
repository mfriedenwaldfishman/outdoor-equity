---
title: "Data Cleaning"
author: "Clarissa Boyajian and Halina Do-Linh"
date: "1/24/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(here)
library(janitor)
library(lubridate)
library(sf)
library(tidycensus)
library(patchwork)
library(scales)
library(tmap)

options(scipen = 999)

# RIDB functions
# raw data
source("functions/function_ridb_subset-pre2018.R")
source("functions/function_ridb_subset-post2019.R")
# calculate variables
source("functions/function_ridb_variable_calculate-pre2018.R")

# ACS functions
source("functions/function_acs_race.R")
source("functions/function_acs_median_income.R")
source("functions/function_acs_transportation.R")
source("functions/function_acs_education.R")

# colors for racial gropus
racial_group_colors <- 
  c("darkgreen", # asian
    "darkblue", # black
    "darkmagenta", # multiracial
    "darkcyan", # native_american
    "darkred", # other
    "darkorange2", # pacific_islander
    "darkgoldenrod1" # white
  )
racial_group <- 
  c("Asian",
    "Black",
    "Multiracial",
    "Native American or Alaskan",
    "Other",
    "Native Hawaiian or \nOther Pacific Islander",
    "White"
  )
```

```{r}
## 2018
# read in data
RIDB_subset_pre2018(full_file_path = "../../data_raw/reservations2018.csv", 
                    state_abbrev = "CA", year = 2018)
# calculate variables
RIDB_calculate_pre2018(input_df_name = data_ridb_2018, output_df_name = "data_ridb_2018")
## create function to standardize values (or add to calculate function)
```

```{r}
# read in census data
acs_subset_calculate_race(geography = "zcta", year = 2018, geometry = FALSE)
# acs_subset_calculate_median_income(geography = "zcta", year = 2018, geometry = FALSE)
# acs_subset_calculate_transportation(geography = "zcta", year = 2018, geometry = FALSE)
# acs_subset_calculate_education(geography = "zcta", year = 2018, geometry = FALSE)
```

```{r}
# create CA only census dataframe with race variable
data_acs_2018_ca_race <- 
  get_acs(geography = "zcta",
          year = 2018,
          geometry = FALSE,
          state = "California",
          summary_var = "B02001_001", #Estimate!!Total:
          variables = c(
            white = "B02001_002", # Estimate!!Total:!!White alone (INCLUDING HISPANIC AND/OR LATINO)
            black = "B02001_003", # Estimate!!Total:!!Black or African American alone
            native_american = "B02001_004", # Estimate!!Total:!!American Indian and Alaska Native alone
            asian = "B02001_005", # Estimate!!Total:!!Asian alone
            pacific_islander = "B02001_006", # Estimate!!Total:!!Native Hawaiian and Other Pacific Islander alone
            other = "B02001_007", # Estimate!!Total:!!Some other race alone
            multiracial = "B02001_008" # Estimate!!Total:!!Two or more races
          )) %>% 
  clean_names() %>% 
  rename(race = variable) %>% 
  mutate(zip_code = str_sub(name, start = -5, end = -1)) %>% 
  group_by(zip_code, race) %>% 
  summarise(percent = estimate / summary_est) %>% 
      pivot_wider(names_from = "race",
                  values_from = "percent")
```




```{r}
# join RIDB and census data
data_combined_2018 <- 
  left_join(x = data_ridb_2018,
            y = data_acs_2018_race_percent,
            by = c("customer_zip" = "zip_code")) %>% 
  drop_na(white, black, asian, multiracial, other, native_american, pacific_islander)

# data_combined_2018_90065 <- data_combined_2018 %>% 
#   filter(customer_zip == 90065)
#   # rowid_to_column("index") %>% 
#   # pivot_longer(cols = 18:24, names_to = "race", values_to = "race_percent")
```

```{r}
# data wrangle for plot
data_plot_1 <- data_combined_2018 %>% 
  summarize(white = sum(white) / nrow(data_combined_2018),
            black = sum(black) / nrow(data_combined_2018),
            asian = sum(asian) / nrow(data_combined_2018),
            multiracial = sum(multiracial) / nrow(data_combined_2018),
            other = sum(other) / nrow(data_combined_2018),
            native_american = sum(native_american) / nrow(data_combined_2018),
            pacific_islander = sum(pacific_islander) / nrow(data_combined_2018)) %>% 
  pivot_longer(cols = 1:7, names_to = "race", values_to = "race_percent_average")

data_plot_1$race <- with(data_plot_1, reorder(race, race_percent_average))

# create plot
plot_1 <- ggplot(data = data_plot_1) +
  geom_col(aes(x = race_percent_average,
               y = race, 
               fill = race)) +
  labs(x = "Probability of a visitors' race",
       y = "Race",
       fill = "Race",
       title = "Racial Breakdown of Visitors\nfor Reservable Overnight Sites in California in 2018") +
  theme_minimal() +
  theme(panel.grid.minor.x = element_blank(),
        plot.background = element_rect("white"),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 14, face = "bold"),
        title = element_text(size = 14, face = "bold"),
        legend.position = "none") +
  scale_fill_manual(values = racial_group_colors) +
  scale_y_discrete(labels = c("Native Hawaiian or Other Pacific Islander",
                              "Native American or Native Alaskan",
                              "Black", "Multiracial", "Other", "Asian", "White"))

plot_1
```

```{r}
ggsave(plot = plot_1, 
       filename = "../figs/2018_bar_race.png",
       width = 12,
       height = 7)
```


```{r}
data_plot_2 <- data_combined_2018 %>% 
  summarize(white = sum(white),
            black = sum(black),
            asian = sum(asian),
            multiracial = sum(multiracial),
            other = sum(other),
            native_american = sum(native_american),
            pacific_islander = sum(pacific_islander)) %>% 
  pivot_longer(cols = 1:7, names_to = "race", values_to = "race_percent_sum")

plot_2 <- ggplot(data = data_plot_2) +
  geom_col(aes(y = race, 
               x = race_percent_sum, 
               fill = race))

plot_2
```

```{r}
data_acs_2018_ca_race <- data_acs_2018_ca_race %>% 
  drop_na(white, black, asian, multiracial, other, native_american, pacific_islander)

data_plot_3 <-  data_acs_2018_ca_race %>% 
  summarize(white = sum(white) / nrow(data_acs_2018_ca_race),
            black = sum(black) / nrow(data_acs_2018_ca_race),
            asian = sum(asian) / nrow(data_acs_2018_ca_race),
            multiracial = sum(multiracial) / nrow(data_acs_2018_ca_race),
            other = sum(other) / nrow(data_acs_2018_ca_race),
            native_american = sum(native_american) / nrow(data_acs_2018_ca_race),
            pacific_islander = sum(pacific_islander) / nrow(data_acs_2018_ca_race)) %>% 
  pivot_longer(cols = 2:8, names_to = "race", values_to = "race_percent_sum")

plot_3 <- ggplot(data = data_plot_3) +
  geom_col(aes(y = race, 
               x = race_percent_sum, 
               fill = race))

plot_3
```

