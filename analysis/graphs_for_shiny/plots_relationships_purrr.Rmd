---
title: "Trying out purr for plot functions"
author: "Clarissa"
date: "4/19/2022"
output: html_document
---

```{r setup, include=FALSE, eval=TRUE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)

library(tidyverse)
library(here)
library(janitor)
library(tidycensus)
library(scales)
library(vroom)
library(plotly)
library(furrr)
library(parallel)
library(future)

admin_unitInput <- "National Park/Forest/Etc."
siteInput <- "Best Site Ever"
```

```{r, eval=TRUE}
start_time <- Sys.time()
```

```{r, eval=TRUE}
# read in joined data
data_ridb_acs_2018 <- vroom(file = "../../../../data_clean/2018_joined_data.csv",
                            delim = ",") ## non-map graphs (no geometries)
# data_ridb_acs_2018 <- readRDS(file = "../../../../data_clean/2018_joined_data.rds") ## maps (don't use RDS for non-map viz, too slow)

# read in CA ACS data for 2018
data_ca_acs_2018 <- vroom(file = "../../../../data_clean/2018_ca_acs_all.csv",
                          delim = ",")
```

## Race x ____

### High categories df

```{r}
# create function to get weighted quartile value for each group (in quartile function .R)
race_top_quartile <- function(race_group, acs_df = data_ca_acs_2018){
  
  df_ca_bin_breaks <- acs_df %>%
    select(zip_code, asian, black, hispanic_latinx, multiracial,
           native_american, other, pacific_islander, white, mean_zip_code_population) %>%
    pivot_longer(cols = 2:9,
                 names_to = "race",
                 values_to = "race_percentage") %>%
    filter(race == race_group) %>% 
    drop_na(race_percentage)
  
  weighted_half <- weighted.mean(x = df_ca_bin_breaks$race_percentage, w = df_ca_bin_breaks$mean_zip_code_population)
  
  df_ca_bin_breaks <- df_ca_bin_breaks %>% filter(race_percentage >= weighted_half)
  
  weighted_quartile <- weighted.mean(x = df_ca_bin_breaks$race_percentage, w = df_ca_bin_breaks$mean_zip_code_population)
  
  return(weighted_quartile)
}

## -- run function through purrr -- ##
race_group <- c("other", "pacific_islander", "multiracial", "asian", 
                "black", "white", "native_american", "hispanic_latinx")

# quartile df (in server.R)
data_race_quants <- 
  race_group %>% 
  map_dbl(race_top_quartile) %>% 
  cbind("race_group" = race_group, 
        "weighted_quartile" = .) %>% 
  as.data.frame()
```


```{r}
## -- create plot showing numbers of reservations for each "high" racial group -- ##
function_plot_top_race_reservations <- function(race_group, weighted_quartile,
                                              ridb_df = data_ridb_acs_2018){
  df <- ridb_df %>% 
    select(park, customer_zip, asian, black, hispanic_latinx, 
           multiracial, native_american, other, pacific_islander, white) %>% 
    pivot_longer(cols = 3:10,
                 names_to = "race",
                 values_to = "race_percentage") %>% 
    filter(race == paste0(race_group)) %>% 
    drop_na(race_percentage) %>% 
    filter(race_percentage >= weighted_quartile) %>% 
    summarize(count = n()) %>% 
    mutate(race = paste0(race_group)) %>% 
    relocate(race, .before = 1) %>% 
    mutate(race = str_replace(string = race,
                              pattern = "_",
                              replacement = " "),
           race = str_to_title(race),
           race = str_replace(string = race,
                              pattern = "Other",
                              replacement = "Other Race(s)"))
  
  return(df)
}

## -- run function through purrr -- ##
data_plot_race_top_race_reservations <- 
  data_race_quants %>% 
  pmap_dfr(function_plot_top_race_reservations)


## -- create plotly -- ##
# parameters
race_group_colors <- c("Other Race(s)" = "#999999", "Pacific Islander" = "#E69F00", "Multiracial" = "#56B4E9",
                       "Asian" = "#009E73", "Black" = "#F0E442", "White" = "#0072B2", 
                       "Native American" = "#D55E00", "Hispanic Latinx" = "#CC79A7")

# plotly
plot <- ggplot(data = data_plot_race_top_race_reservations) +
  geom_col(aes(x = count,
               y = reorder(race, count),
               fill = race,
               text = paste0(comma(count, accuracy = 1), 
                             " reservations were made by <br>people who live in ZIP codes with high ", 
                             race, " populations."))) +
  scale_x_continuous(labels = comma) +
  scale_y_discrete(expand = c(0.3, 0)) +
  scale_fill_manual(values = race_group_colors) +
  scale_color_manual(values = race_group_colors) +
  labs(x = paste("Number of Reservations"),
       y = "",
       title = paste0("Number of Reservations by <br> People from Communities with High Rates of Different Racial Groups")) + 
  theme_minimal() +
  theme(plot.background = element_rect("white"),
        panel.grid.major.y = element_blank(),
        legend.position = "none")

ggplotly(plot,
         tooltip = list("text")) %>%
  config(modeBarButtonsToRemove = list("pan", "select", "lasso2d", "autoScale2d", 
                                       "hoverClosestCartesian", "hoverCompareCartesian")) %>% 
  add_annotations(text = "Reservations from ZIP codes<br>with high proportions of:", 
                  x = -0.15, xref = 'paper', y = 0.97, yref = 'paper', 
                  showarrow = FALSE)
```


### Race x distance traveled

```{r}
## -- create function to make plot df -- ##
function_plot_race_distanceTravel <- function(race_group, weighted_quartile,
                                              ridb_df = data_ridb_acs_2018){
  
  df <- ridb_df %>% 
    select(park, customer_zip, asian, black, hispanic_latinx, 
           multiracial, native_american, other, pacific_islander, white,
           distance_traveled_m) %>% 
    mutate(distance_traveled_mi = distance_traveled_m * 0.000621371) %>% 
    drop_na(distance_traveled_mi) %>% 
    pivot_longer(cols = 3:10,
                 names_to = "race",
                 values_to = "race_percentage") %>% 
    filter(race == paste0(race_group)) %>% 
    drop_na(race_percentage) %>% 
    filter(race_percentage >= weighted_quartile) %>% 
    summarize(median_distance_traveled_mi = median(distance_traveled_mi),
              quartile_lower = quantile(distance_traveled_mi)[[2]],
              quartile_upper = quantile(distance_traveled_mi)[[4]],
              count = n()) %>% 
    mutate(race = paste0(race_group)) %>% 
    relocate(race, .before = 1) %>% 
    mutate(race = str_replace(string = race,
                              pattern = "_",
                              replacement = " "),
           race = str_to_title(race),
           race = str_replace(string = race,
                              pattern = "Other",
                              replacement = "Other Race(s)"))
  
  return(df)
}
```


```{r}
## -- run function through purrr -- ##
data_plot_race_distanceTravel <- 
  data_race_quants %>% 
  pmap_dfr(function_plot_race_distanceTravel)


## -- create plot -- ##
# parameters
race_group_colors <- c("Other Race(s)" = "#999999", "Pacific Islander" = "#E69F00", "Multiracial" = "#56B4E9",
                       "Asian" = "#009E73", "Black" = "#F0E442", "White" = "#0072B2", 
                       "Native American" = "#D55E00", "Hispanic Latinx" = "#CC79A7")

# plotly
plot_race_distance_traveled <- ggplot(data = data_plot_race_distanceTravel, 
                                      aes(x = median_distance_traveled_mi,
                                          y = reorder(race, median_distance_traveled_mi))) +
  geom_segment(aes(xend = 0, yend = race)) +
  geom_point(aes(color = race, fill = race,
                 text = paste0(comma(count, accuracy = 1), 
                               " unique visits were made by people who live in ZIP codes<br>with high ",
                               str_to_title(race) %>% 
                                 str_replace(string = ., pattern = "\\(S\\)", "\\(s\\)"), 
                               " populations. Typically folks traveled between<br>",
                               comma(quartile_lower, accuracy = 1), 
                               " and ", comma(quartile_upper, accuracy = 1), 
                               " miles, with a median distance of ", 
                               comma(median_distance_traveled_mi, accuracy = 1), 
                               " miles.")),
             size = 3.5, 
             shape = 21, stroke = 2) +
  scale_y_discrete(expand = c(0.3, 0)) +
  scale_fill_manual(values = race_group_colors) +
  scale_color_manual(values = race_group_colors) +
  labs(x = paste("Estimated Distance Traveled from Home to Site (miles)"),
       y = "",
       title = paste0("Distance Traveled by Different Racial Groups to<br>", 
                      siteInput, ", ", admin_unitInput, " in 2018")) + 
  theme_minimal() +
  theme(plot.background = element_rect("white"),
        panel.grid.major.y = element_blank(),
        legend.position = "none")

ggplotly(plot_race_distance_traveled,
         tooltip = list("text")) %>%
  config(modeBarButtonsToRemove = list("pan", "select", "lasso2d", "autoScale2d", 
                                       "hoverClosestCartesian", "hoverCompareCartesian")) %>% 
  add_annotations(text = "Reservations from ZIP codes<br>with high proportions of:", 
                  x = -0.15, xref = 'paper', y = 0.95, yref = 'paper', 
                  showarrow = FALSE)
```


### Race x site type 

```{r}
## -- create function to make plot df -- ##
function_plot_race_siteType <- function(race_group, weighted_quartile,
                                        ridb_df = data_ridb_acs_2018){
  
  df <- ridb_df %>% 
    select(agency, admin_unit, park, customer_zip, asian, black, hispanic_latinx, 
           multiracial, native_american, other, pacific_islander, white,
           aggregated_site_type) %>% 
    drop_na(aggregated_site_type) %>% 
    pivot_longer(cols = 5:12,
                 names_to = "race",
                 values_to = "race_percentage") %>% 
    filter(race == paste0(race_group)) %>%
    drop_na(race_percentage) %>%
    filter(race_percentage >= weighted_quartile) %>% 
    count(race, aggregated_site_type) %>% 
    rename(count = n) %>% 
    mutate(race = paste0(race_group)) %>%
    relocate(race, .before = 1) %>% 
    mutate(race = str_replace(string = race,
                              pattern = "_",
                              replacement = " "),
           race = str_to_title(race),
           race = str_replace(string = race,
                              pattern = "Other",
                              replacement = "Other Race(s)"))
  
  return(df)
}
```


```{r}
## -- run function through purrr -- ##
data_plot_race_siteType <- 
  data_race_quants %>% 
  pmap_dfr(function_plot_race_siteType)


## -- create plot -- ##
# parameters
race_group_colors <- c("Other Race(s)" = "#999999", "Pacific Islander" = "#E69F00", "Multiracial" = "#56B4E9",
                       "Asian" = "#009E73", "Black" = "#F0E442", "White" = "#0072B2", 
                       "Native American" = "#D55E00", "Hispanic Latinx" = "#CC79A7")

# subset data to site type category
site_type_categories <- c("equestrian", "remote", "rv only", "rv or tent", "shelter", "tent only", "water")

data_plot_race_siteType_category <- data_plot_race_siteType %>% 
  filter(aggregated_site_type == site_type_categories[[1]]) %>% 
  mutate(aggregated_site_type = str_to_title(aggregated_site_type),
         aggregated_site_type = str_replace(string = aggregated_site_type,
                                            pattern = "Rv", 
                                            replacement = "RV"))

# create plot
plot_race_site_type_equestrian <- 
  ggplot(data = data_plot_race_siteType_category) +
  geom_col(aes(x = count,
               y = reorder(race, count),
               fill = race,
               text = paste0("Of visits to ", aggregated_site_type, " overnight reservable sites, ", 
                             comma(count, accuracy = 1), 
                             " reservations were made by <br>people who live in ZIP codes with high ", 
                             race, " populations."))) +
  scale_y_discrete(expand = c(0.3, 0)) +
  scale_fill_manual(values = race_group_colors) +
  scale_color_manual(values = race_group_colors) +
  labs(x = paste("Number of Reservations"),
       y = "",
       title = paste0("Number of Reservations to ", str_to_title(site_type_categories[[1]]) %>% 
                            str_replace(string = ., pattern = "Rv", replacement = "RV"),
                      " Sites by <br> People from Communities with High Rates of Different Racial Groups")) + 
  theme_minimal() +
  theme(plot.background = element_rect("white"),
        panel.grid.major.y = element_blank(),
        legend.position = "none")

ggplotly(plot_race_site_type_equestrian,
         tooltip = list("text")) %>%
  config(modeBarButtonsToRemove = list("pan", "select", "lasso2d", "autoScale2d", 
                                       "hoverClosestCartesian", "hoverCompareCartesian")) %>% 
  add_annotations(text = "Reservations from ZIP codes<br>with high proportions of:", 
                  x = -0.15, xref = 'paper', y = 0.97, yref = 'paper', 
                  showarrow = FALSE)
```



### Race x booking window 

```{r}
## -- create function to make plot df -- ##
function_plot_race_bookWindow <- function(race_group, weighted_quartile,
                                        ridb_df = data_ridb_acs_2018){
  
  df <- ridb_df %>% 
    select(park, customer_zip, asian, black, hispanic_latinx, 
           multiracial, native_american, other, pacific_islander, white,
           booking_window) %>% 
    drop_na(booking_window) %>% 
    pivot_longer(cols = 3:10,
                 names_to = "race",
                 values_to = "race_percentage") %>% 
    filter(race == race_group) %>%
    drop_na(race_percentage) %>% 
    filter(race_percentage >= weighted_quartile) %>% 
    summarize(median_booking_window = median(booking_window),
              quartile_lower = quantile(booking_window)[[2]],
              quartile_upper = quantile(booking_window)[[4]],
              count = n()) %>% 
    mutate(race = paste0(race_group)) %>%
    relocate(race, .before = 1) %>% 
    mutate(race = str_replace(string = race,
                              pattern = "_",
                              replacement = " "),
           race = str_to_title(race),
           race = str_replace(string = race,
                              pattern = "Other",
                              replacement = "Other Race(s)"))
  
  return(df)
}
```

```{r}
## -- run function through purrr -- ##
data_plot_race_bookWindow <- 
  data_race_quants %>% 
  pmap_dfr(function_plot_race_bookWindow)

## -- create plot -- ##
# parameters
race_group_colors <- c("Other Race(s)" = "#999999", "Pacific Islander" = "#E69F00", "Multiracial" = "#56B4E9",
                              "Asian" = "#009E73", "Black" = "#F0E442", "White" = "#0072B2", 
                              "Native American" = "#D55E00", "Hispanic Latinx" = "#CC79A7")

# plotly
plot_race_booking_window <- ggplot(data = data_plot_race_bookWindow, 
                                      aes(x = median_booking_window,
                                          y = reorder(race, median_booking_window))) +
  geom_segment(aes(xend = 0, yend = race)) +
  geom_point(aes(color = race, fill = race,
                 text = paste0(comma(count, accuracy = 1), 
                               " unique visits were made by people who live in ZIP codes<br>with high ",
                               str_to_title(race) %>% 
                                 str_replace(string = ., pattern = "\\(S\\)", "\\(s\\)"), 
                               " populations. Typically folks reserved their visit between<br>",
                               comma(quartile_lower, accuracy = 1), 
                               " and ", comma(quartile_upper, accuracy = 1), 
                               " days before the start of their trip, with a median booking window of ", 
                               comma(median_booking_window, accuracy = 1), 
                               " days.")),
             size = 3.5, 
             shape = 21, stroke = 2) +
  scale_y_discrete(expand = c(0.3, 0)) +
  scale_fill_manual(values = race_group_colors) +
  scale_color_manual(values = race_group_colors) +
  labs(x = paste("Estimated Number of Days in Advance Site is Reserved (days)"),
       y = "",
       title = paste0("Number of Days in Advance Site is Reserved by Different Racial Groups to<br>", 
                      siteInput, ", ", admin_unitInput, " in 2018")) + 
  theme_minimal() +
  theme(plot.background = element_rect("white"),
        panel.grid.major.y = element_blank(),
        legend.position = "none")

ggplotly(plot_race_booking_window,
         tooltip = list("text")) %>%
  config(modeBarButtonsToRemove = list("pan", "select", "lasso2d", "autoScale2d", 
                                       "hoverClosestCartesian", "hoverCompareCartesian")) %>% 
  add_annotations(text = "Reservations from ZIP codes<br>with high proportions of:", 
                  x = -0.15, xref = 'paper', y = 0.95, yref = 'paper', 
                  showarrow = FALSE)
```


### Race x daily cost 

```{r}
## -- create function to make plot df -- ##
function_plot_race_dailyCost <- function(race_group, weighted_quartile,
                                         ridb_df = data_ridb_acs_2018){
  
  df <- ridb_df %>% 
    select(park, customer_zip, asian, black, hispanic_latinx, 
           multiracial, native_american, other, pacific_islander, white,
           daily_cost) %>% 
    drop_na(daily_cost) %>% 
    filter(daily_cost != Inf) %>% 
    pivot_longer(cols = 3:10,
                 names_to = "race",
                 values_to = "race_percentage") %>% 
    filter(race == race_group) %>%
    drop_na(race_percentage) %>% 
    filter(race_percentage >= weighted_quartile) %>% 
    summarize(median_daily_cost = median(daily_cost),
              quartile_lower = quantile(daily_cost)[[2]],
              quartile_upper = quantile(daily_cost)[[4]],
              count = n()) %>% 
    mutate(race = paste0(race_group)) %>%  ## BACK TO i
    relocate(race, .before = 1) %>% 
    mutate(race = str_replace(string = race,
                              pattern = "_",
                              replacement = " "),
           race = str_to_title(race),
           race = str_replace(string = race,
                              pattern = "Other",
                              replacement = "Other Race(s)"))
  
  return(df)
}
```

```{r}
## -- run function through purrr -- ##
data_plot_race_dailyCost <- 
  data_race_quants %>% 
  pmap_dfr(function_plot_race_dailyCost)

## -- create plot -- ##

# parameters
race_group_colors <- c("Other Race(s)" = "#999999", "Pacific Islander" = "#E69F00", "Multiracial" = "#56B4E9",
                              "Asian" = "#009E73", "Black" = "#F0E442", "White" = "#0072B2", 
                              "Native American" = "#D55E00", "Hispanic Latinx" = "#CC79A7")

# plotly
plot_race_daily_cost <- ggplot(data = data_plot_race_dailyCost, 
                                      aes(x = median_daily_cost,
                                          y = reorder(race, median_daily_cost))) +
  geom_segment(aes(xend = 0, yend = race)) +
  geom_point(aes(color = race, fill = race,
                 text = paste0(comma(count, accuracy = 1), 
                               " unique visits were made by people who live in ZIP codes<br>with high ",
                               str_to_title(race) %>% 
                                 str_replace(string = ., pattern = "\\(S\\)", "\\(s\\)"), 
                               " populations. Typically these visitors paid between<br>",
                               dollar(quartile_lower), 
                               " and ", dollar(quartile_upper), 
                               " per day for reservations, with a median of ", 
                               dollar(median_daily_cost), 
                               ".")),
             size = 3.5, 
             shape = 21, stroke = 2) +
  scale_x_continuous(labels = dollar) +
  scale_y_discrete(expand = c(0.3, 0)) +
  scale_fill_manual(values = race_group_colors) +
  scale_color_manual(values = race_group_colors) +
  labs(x = paste("Estimated Daily Cost per Reservation (US $)"),
       y = "",
       title = paste0("Daily Costs per Reservation Paid by Different Racial Groups to<br>", 
                      siteInput, ", ", admin_unitInput, " in 2018")) + 
  theme_minimal() +
  theme(plot.background = element_rect("white"),
        panel.grid.major.y = element_blank(),
        legend.position = "none")

ggplotly(plot_race_daily_cost,
         tooltip = list("text")) %>%
  config(modeBarButtonsToRemove = list("pan", "select", "lasso2d", "autoScale2d", 
                                       "hoverClosestCartesian", "hoverCompareCartesian")) %>% 
  add_annotations(text = "Reservations from ZIP codes<br>with high proportions of:", 
                  x = -0.15, xref = 'paper', y = 0.95, yref = 'paper', 
                  showarrow = FALSE)
```


### Race x daily cost per visitor

```{r}
## -- create function to make plot df -- ##
function_plot_race_dailyCostPerVisitor <- function(race_group, weighted_quartile,
                                         ridb_df = data_ridb_acs_2018){
  
  df <- ridb_df %>% 
    select(park, customer_zip, asian, black, hispanic_latinx, 
           multiracial, native_american, other, pacific_islander, white,
           daily_cost_per_visitor) %>% 
    drop_na(daily_cost_per_visitor) %>% 
    filter(daily_cost_per_visitor != Inf) %>% 
    pivot_longer(cols = 3:10,
                 names_to = "race",
                 values_to = "race_percentage") %>% 
    filter(race == race_group) %>%
    drop_na(race_percentage) %>% 
    filter(race_percentage >= weighted_quartile) %>% 
    summarize(median_daily_cost_per_visitor = median(daily_cost_per_visitor),
              quartile_lower = quantile(daily_cost_per_visitor)[[2]],
              quartile_upper = quantile(daily_cost_per_visitor)[[4]],
              count = n()) %>% 
    mutate(race = paste0(race_group)) %>%  ## BACK TO i
    relocate(race, .before = 1) %>% 
    mutate(race = str_replace(string = race,
                              pattern = "_",
                              replacement = " "),
           race = str_to_title(race),
           race = str_replace(string = race,
                              pattern = "Other",
                              replacement = "Other Race(s)"))
  
  return(df)
}
```

```{r}
## -- run function through purrr -- ##
data_plot_race_dailyCostPerVisitor <- 
  data_race_quants %>% 
  pmap_dfr(function_plot_race_dailyCostPerVisitor)

## -- create plot -- ##

# parameters
race_group_colors <- c("Other Race(s)" = "#999999", "Pacific Islander" = "#E69F00", "Multiracial" = "#56B4E9",
                              "Asian" = "#009E73", "Black" = "#F0E442", "White" = "#0072B2", 
                              "Native American" = "#D55E00", "Hispanic Latinx" = "#CC79A7")

# plotly
plot_race_daily_cost_per_visitor <- ggplot(data = data_plot_race_dailyCostPerVisitor, 
                                      aes(x = median_daily_cost_per_visitor,
                                          y = reorder(race, median_daily_cost_per_visitor))) +
  geom_segment(aes(xend = 0, yend = race)) +
  geom_point(aes(color = race, fill = race,
                 text = paste0(comma(count, accuracy = 1), 
                               " unique visits were made by people who live in ZIP codes<br>with high ",
                               str_to_title(race) %>% 
                                 str_replace(string = ., pattern = "\\(S\\)", "\\(s\\)"), 
                               " populations. Typically these visitors paid between<br>",
                               dollar(quartile_lower), 
                               " and ", dollar(quartile_upper), 
                               " per day for reservations, with a median of ", 
                               dollar(median_daily_cost_per_visitor), 
                               ".")),
             size = 3.5, 
             shape = 21, stroke = 2) +
  scale_x_continuous(labels = dollar) +
  scale_y_discrete(expand = c(0.3, 0)) +
  scale_fill_manual(values = race_group_colors) +
  scale_color_manual(values = race_group_colors) +
  labs(x = paste("Estimated Daily Cost per Visitor (US $)"),
       y = "",
       title = paste0("Daily Costs per Visitor Paid by Different Racial Groups to<br>", 
                      siteInput, ", ", admin_unitInput, " in 2018")) + 
  theme_minimal() +
  theme(plot.background = element_rect("white"),
        panel.grid.major.y = element_blank(),
        legend.position = "none")

ggplotly(plot_race_daily_cost_per_visitor,
         tooltip = list("text")) %>%
  config(modeBarButtonsToRemove = list("pan", "select", "lasso2d", "autoScale2d", 
                                       "hoverClosestCartesian", "hoverCompareCartesian")) %>% 
  add_annotations(text = "Reservations from ZIP codes<br>with high proportions of:", 
                  x = -0.15, xref = 'paper', y = 0.95, yref = 'paper', 
                  showarrow = FALSE)
```



### Race x length of stay 

```{r}
## -- create function to make plot df -- ##
function_plot_race_lengthOfStay <- function(race_group, weighted_quartile,
                                         ridb_df = data_ridb_acs_2018){
  
  df <- ridb_df %>% 
    select(park, customer_zip, asian, black, hispanic_latinx, 
           multiracial, native_american, other, pacific_islander, white,
           length_of_stay) %>% 
    drop_na(length_of_stay) %>% 
    filter(length_of_stay >= 0) %>% 
  pivot_longer(cols = 3:10,
               names_to = "race",
               values_to = "race_percentage") %>% 
    filter(race == race_group) %>% 
    drop_na(race_percentage) %>% 
    filter(race_percentage >= weighted_quartile) %>% 
    summarize(median_length_of_stay = median(length_of_stay),
              quartile_lower = quantile(length_of_stay)[[2]],
              quartile_upper = quantile(length_of_stay)[[4]],
              count = n()) %>% 
    mutate(race = paste0(race_group)) %>% 
    relocate(race, .before = 1) %>% 
    mutate(race = str_replace(string = race,
                              pattern = "_",
                              replacement = " "),
           race = str_to_title(race),
           race = str_replace(string = race,
                              pattern = "Other",
                              replacement = "Other Race(s)"))
  
  return(df)
}
```

```{r}
## -- run function through purrr -- ##
data_plot_race_lengthOfStay <- 
  data_race_quants %>% 
  pmap_dfr(function_plot_race_lengthOfStay)

## -- create plot -- ##

# parameters
race_group_colors <- c("Other Race(s)" = "#999999", "Pacific Islander" = "#E69F00", "Multiracial" = "#56B4E9",
                              "Asian" = "#009E73", "Black" = "#F0E442", "White" = "#0072B2", 
                              "Native American" = "#D55E00", "Hispanic Latinx" = "#CC79A7")

# plotly
plot_race_length_of_stay <- ggplot(data = data_plot_race_lengthOfStay, 
                                      aes(x = median_length_of_stay,
                                          y = reorder(race, median_length_of_stay))) +
  geom_segment(aes(xend = 0, yend = race)) +
  geom_point(aes(color = race, fill = race,
                 text = paste0(comma(count, accuracy = 1), 
                               " unique visits were made by people who live in ZIP codes<br>with high ",
                               str_to_title(race) %>% 
                                 str_replace(string = ., pattern = "\\(S\\)", "\\(s\\)"), 
                               " populations. Typically these visitors stayed between<br>",
                               dollar(quartile_lower), 
                               " and ", dollar(quartile_upper), 
                               " days, with a median of ", 
                               dollar(median_length_of_stay), 
                               " days.")),
             size = 3.5, 
             shape = 21, stroke = 2) +
  scale_x_continuous(labels = comma) +
  scale_y_discrete(expand = c(0.3, 0)) +
  scale_fill_manual(values = race_group_colors) +
  scale_color_manual(values = race_group_colors) +
  labs(x = paste("Estimated Length of Stay (days)"),
       y = "",
       title = paste0("Length of Stay by Different Racial Groups to<br>", 
                      siteInput, ", ", admin_unitInput, " in 2018")) + 
  theme_minimal() +
  theme(plot.background = element_rect("white"),
        panel.grid.major.y = element_blank(),
        legend.position = "none")

ggplotly(plot_race_daily_cost_per_visitor,
         tooltip = list("text")) %>%
  config(modeBarButtonsToRemove = list("pan", "select", "lasso2d", "autoScale2d", 
                                       "hoverClosestCartesian", "hoverCompareCartesian")) %>% 
  add_annotations(text = "Reservations from ZIP codes<br>with high proportions of:", 
                  x = -0.15, xref = 'paper', y = 0.95, yref = 'paper', 
                  showarrow = FALSE)
```


## Education x ____

### High categories df

```{r }
# create function to get weighted quartile value for each group (in quartile function .R)
education_top_quartile <- function(education_group, acs_df = data_ca_acs_2018){
  
  df_ca_bin_breaks <- acs_df %>%
    select(zip_code, hs_GED_or_below, some_college, college, master_or_above, mean_zip_code_population) %>% 
    pivot_longer(cols = 2:5,
                 names_to = "education",
                 values_to = "education_percentage") %>% 
    filter(education == education_group) %>% 
    drop_na(education_percentage)
  
  weighted_half <- weighted.mean(x = df_ca_bin_breaks$education_percentage, w = df_ca_bin_breaks$mean_zip_code_population)
  
  df_ca_bin_breaks <- df_ca_bin_breaks %>% filter(education_percentage >= weighted_half)
  
  weighted_quartile <- weighted.mean(x = df_ca_bin_breaks$education_percentage, w = df_ca_bin_breaks$mean_zip_code_population)
  
  return(weighted_quartile)
}

## -- run function through purrr -- ##
education_group <- c("hs_GED_or_below", "some_college", "college", "master_or_above")

# quartile df (in server.R)
data_education_quants <- 
  education_group %>% 
  map_dbl(education_top_quartile) %>% 
  cbind("education_group" = education_group, 
        "weighted_quartile" = .) %>% 
  as.data.frame()
```



```{r}
## -- create plot showing numbers of reservations for each "high" racial group -- ##
function_plot_top_education_reservations <- function(education_group, weighted_quartile,
                                              ridb_df = data_ridb_acs_2018){
  df <- ridb_df %>% 
    select(park, customer_zip, hs_GED_or_below, some_college, college, master_or_above) %>% 
    pivot_longer(cols = 3:6,
                 names_to = "education",
                 values_to = "education_percentage") %>% 
    filter(education == paste0(education_group)) %>% 
    drop_na(education_percentage) %>% 
    filter(education_percentage >= weighted_quartile) %>% 
    summarize(count = n()) %>% 
    mutate(education = paste0(education_group)) %>% 
    relocate(education, .before = 1) %>% 
    mutate(education = str_replace_all(string = education,
                              pattern = "_",
                              replacement = " "),
           education = str_to_title(education),
           education = str_replace(string = education,
                                   pattern = "Hs Ged Or", 
                                   replacement = "HS, GED, or"),
           education = str_replace(string = education,
                                   pattern = "Some College",
                                   replacement = "Some College or Trade School"),
           education = str_replace(string = education,
                                   pattern = "^College$",
                                   replacement = "Associates or Bachelors Degree"),
           education = str_replace(string = education,
                                   pattern = "Master Or Above",
                                   replacement = "Masters Degree or Above"),
           education_y_lab = case_when(education == "HS, GED, or Below" ~ "HS, GED,\nor Below",
                                       education == "Some College or Trade School" ~ "Some College or\nTrade School",
                                       education == "Associates or Bachelors Degree" ~ "Associates or\nBachelors Degree",
                                       education == "Masters Degree or Above" ~ "Masters Degree\nor Above"),
           education_y_lab = factor(education_y_lab, levels = c("HS, GED,\nor Below", 
                                                    "Some College or\nTrade School", 
                                                    "Associates or\nBachelors Degree", 
                                                    "Masters Degree\nor Above")))
  
  return(df)
}

## -- run function through purrr -- ##
data_plot_top_education_reservations <- 
  data_education_quants %>% 
  pmap_dfr(function_plot_top_education_reservations)


## -- create plotly -- ##
# parameters
education_group_colors <- c("HS, GED,\nor Below" = "#a6cee3", "Some College or\nTrade School"  = "#1f78b4", 
                      "Associates or\nBachelors Degree" = "#b2df8a", "Masters Degree\nor Above" = "#33a02c")

#plotly
plot <- ggplot(data = data_plot_top_education_reservations) +
  geom_col(aes(x = count,
               y = education_y_lab,
               fill = education_y_lab,
               text = paste0(comma(count, accuracy = 1), 
                             " reservations were made by <br>people who live in ZIP codes with high ", 
                             education, " populations."))) +
  scale_x_continuous(labels = comma) +
  scale_y_discrete(expand = c(0.4, 0)) +
  scale_fill_manual(values = education_group_colors) +
  scale_color_manual(values = education_group_colors) +
  labs(x = paste("Number of Reservations"),
       y = "",
       title = paste0("Number of Reservations by <br> People from Communities with High Rates of Different Education Levels")) + 
  theme_minimal() +
  theme(plot.background = element_rect("white"),
        panel.grid.major.y = element_blank(),
        legend.position = "none")

ggplotly(plot,
         tooltip = list("text")) %>%
  config(modeBarButtonsToRemove = list("pan", "select", "lasso2d", "autoScale2d", 
                                       "hoverClosestCartesian", "hoverCompareCartesian")) %>% 
  add_annotations(text = "Reservations from ZIP codes<br>with high proportions of:", 
                  x = -0.15, xref = 'paper', y = 0.97, yref = 'paper', 
                  showarrow = FALSE)
```





### Education x distance traveled 

```{r}
## -- create function to make plot df -- ##
function_plot_education_distanceTravel <- function(education_group, weighted_quartile,
                                              ridb_df = data_ridb_acs_2018){
  
  df <- ridb_df %>% 
    select(park, customer_zip, hs_GED_or_below, some_college, 
           college, master_or_above, distance_traveled_m) %>% 
    mutate(distance_traveled_mi = distance_traveled_m * 0.000621371) %>% 
    drop_na(distance_traveled_mi) %>% 
    pivot_longer(cols = 3:6,
                 names_to = "education",
                 values_to = "education_percentage") %>% 
    filter(education == paste0(education_group)) %>% 
    drop_na(education_percentage) %>% 
    filter(education_percentage >= weighted_quartile) %>% 
    summarize(median_distance_traveled_mi = median(distance_traveled_mi),
              quartile_lower = quantile(distance_traveled_mi)[[2]],
              quartile_upper = quantile(distance_traveled_mi)[[4]],
              count = n()) %>% 
    mutate(education = paste0(education_group)) %>% 
    relocate(education, .before = 1) %>% 
    mutate(education = str_replace_all(string = education,
                              pattern = "_",
                              replacement = " "),
           education = str_to_title(education),
           education = str_replace(string = education,
                                   pattern = "Hs Ged Or", 
                                   replacement = "HS, GED, or"),
           education = str_replace(string = education,
                                   pattern = "Some College",
                                   replacement = "Some College or Trade School"),
           education = str_replace(string = education,
                                   pattern = "^College$",
                                   replacement = "Associates or Bachelors Degree"),
           education = str_replace(string = education,
                                   pattern = "Master Or Above",
                                   replacement = "Masters Degree or Above"),
           education_y_lab = case_when(education == "HS, GED, or Below" ~ "HS, GED,\nor Below",
                                       education == "Some College or Trade School" ~ "Some College or\nTrade School",
                                       education == "Associates or Bachelors Degree" ~ "Associates or\nBachelors Degree",
                                       education == "Masters Degree or Above" ~ "Masters Degree\nor Above"),
           education_y_lab = factor(education_y_lab, levels = c("HS, GED,\nor Below", 
                                                    "Some College or\nTrade School", 
                                                    "Associates or\nBachelors Degree", 
                                                    "Masters Degree\nor Above")))
  
  return(df)
}
```


```{r}
## -- run function through purrr -- ##
data_plot_education_distanceTravel <- 
  data_education_quants %>% 
  pmap_dfr(function_plot_education_distanceTravel)


## -- create plot -- ##
# parameters
education_group_colors <- c("HS, GED,\nor Below" = "#a6cee3", "Some College or\nTrade School"  = "#1f78b4", 
                      "Associates or\nBachelors Degree" = "#b2df8a", "Masters Degree\nor Above" = "#33a02c")

# plotly
plot_education_distance_traveled <- ggplot(data = data_plot_education_distanceTravel, 
                                      aes(x = median_distance_traveled_mi,
                                          y = education_y_lab)) +
  geom_segment(aes(xend = 0, yend = education_y_lab)) +
  geom_point(aes(color = education_y_lab, fill = education_y_lab,
                 text = paste0(comma(count, accuracy = 1), 
                               " unique visits were made by people who live in ZIP codes with high rates of<br>",
                               education, 
                               " as the highest level of education. Typically these visitors<br>traveled between ",
                               comma(quartile_lower, accuracy = 1), 
                               " and ", comma(quartile_upper, accuracy = 1), 
                               " miles, with a median distance of ", 
                               comma(median_distance_traveled_mi, accuracy = 1), 
                               " miles.")),
             size = 3.5, 
             shape = 21, stroke = 2) +
  scale_y_discrete(expand = c(0.35, 0)) +
  scale_fill_manual(values = education_group_colors) +
  scale_color_manual(values = education_group_colors) +
  labs(x = paste("Estimated Distance Traveled from Home to Site (miles)"),
       y = "") + 
  theme_minimal() +
  theme(plot.background = element_rect("white"),
        panel.grid.major.y = element_blank(),
        legend.position = "none")

ggplotly(plot_education_distance_traveled,
         tooltip = list("text")) %>%
  config(modeBarButtonsToRemove = list("pan", "select", "lasso2d", "autoScale2d", 
                                       "hoverClosestCartesian", "hoverCompareCartesian")) %>% 
    layout(title = list(text = paste0('<b>', siteInput, '<br>', admin_unitInput, '</b>',
                                      '<br>',
                                      'Distance Traveled by Visitors with Different Levels of Education'),
                        font = list(size = 15))) %>%  
  add_annotations(text = "Reservations from ZIP codes<br>with high proportions of:", 
                  x = -0.15, xref = 'paper', y = 0.93, yref = 'paper', 
                  showarrow = FALSE)
```


### Education x site type

```{r}
## -- create function to make plot df -- ##
function_plot_education_siteType <- function(education_group, weighted_quartile,
                                              ridb_df = data_ridb_acs_2018){
  
  df <- ridb_df %>% 
    select(park, customer_zip, hs_GED_or_below, 
           some_college, college, master_or_above, aggregated_site_type) %>% 
    drop_na(aggregated_site_type) %>% 
    pivot_longer(cols = 3:6,
                 names_to = "education",
                 values_to = "education_percentage") %>% 
    filter(education == paste0(education_group)) %>% 
    drop_na(education_percentage) %>% 
    filter(education_percentage >= weighted_quartile) %>% 
    count(education, aggregated_site_type) %>% 
    rename(count = n) %>% 
    mutate(education = paste0(education_group)) %>% 
    relocate(education, .before = 1) %>%
    mutate(education = str_replace_all(string = education,
                                       pattern = "_",
                                       replacement = " "),
           education = str_to_title(education),
           education = str_replace(string = education,
                                   pattern = "Hs Ged Or", 
                                   replacement = "HS, GED, or"),
           education = str_replace(string = education,
                                   pattern = "Some College",
                                   replacement = "Some College or Trade School"),
           education = str_replace(string = education,
                                   pattern = "^College$",
                                   replacement = "Associates or Bachelors Degree"),
           education = str_replace(string = education,
                                   pattern = "Master Or Above",
                                   replacement = "Masters Degree or Above"),
           education_y_lab = case_when(education == "HS, GED, or Below" ~ "HS, GED,\nor Below",
                                       education == "Some College or Trade School" ~ "Some College or\nTrade School",
                                       education == "Associates or Bachelors Degree" ~ "Associates or\nBachelors Degree",
                                       education == "Masters Degree or Above" ~ "Masters Degree\nor Above"),
           education_y_lab = factor(education_y_lab, levels = c("HS, GED,\nor Below", 
                                                    "Some College or\nTrade School", 
                                                    "Associates or\nBachelors Degree", 
                                                    "Masters Degree\nor Above")))
  
  return(df)
}
```

```{r}
## -- run function through purrr -- ##
data_plot_education_siteType <- 
  data_education_quants %>% 
  pmap_dfr(function_plot_education_siteType)

## -- create plot -- ##

# parameters
education_group_colors <- c("HS, GED,\nor Below" = "#a6cee3", "Some College or\nTrade School"  = "#1f78b4", 
                      "Associates or\nBachelors Degree" = "#b2df8a", "Masters Degree\nor Above" = "#33a02c")

# subset data to site type category
site_type_categories <- c("equestrian", "remote", "rv only", "rv or tent", "shelter", "tent only", "water")

data_plot_education_siteType_category <- data_plot_education_siteType %>% 
  filter(aggregated_site_type == site_type_categories[[1]]) %>% 
  mutate(aggregated_site_type = str_to_title(aggregated_site_type),
         aggregated_site_type = str_replace(string = aggregated_site_type,
                                            pattern = "Rv", 
                                            replacement = "RV"))

# plotly
plot_education_distance_traveled <- ggplot(data = data_plot_education_siteType_category) +
  geom_col(aes(x = count,
               y = education_y_lab,
               fill = education_y_lab,
               text = paste0("Of visits to ", aggregated_site_type, " overnight reservable sites, ", 
                             comma(count, accuracy = 1), 
                             " reservations were made by <br>people who live in ZIP codes with high ", 
                             education, " populations."))) +
  scale_y_discrete(expand = c(0.5, 0)) +
  scale_fill_manual(values = education_group_colors) +
  scale_color_manual(values = education_group_colors) +
  labs(x = paste("Number of Reservations"),
       y = "",
       title = paste0("Number of Reservations to ", str_to_title(site_type_categories[[1]]) %>% 
                        str_replace(string = ., pattern = "Rv", replacement = "RV"),
                      " Sites by <br> People from Communities with High Rates of Different Racial Groups")) + 
  theme_minimal() +
  theme(plot.background = element_rect("white"),
        panel.grid.major.y = element_blank(),
        legend.position = "none")


ggplotly(plot_education_distance_traveled,
         tooltip = list("text")) %>%
  config(modeBarButtonsToRemove = list("pan", "select", "lasso2d", "autoScale2d", 
                                       "hoverClosestCartesian", "hoverCompareCartesian")) %>% 
  layout(title = list(text = paste0('<b>', siteInput, '<br>', admin_unitInput, '</b>',
                                    '<br>',
                                    "Number of Reservations to ", str_to_title(site_type_categories[[1]]) %>%
                                      str_replace(string = ., pattern = "Rv", replacement = "RV"), 
                                    " Sites by Visitors with Different Levels of Education"),
                      font = list(size = 15))) %>%  
  add_annotations(text = "Reservations from ZIP codes<br>with high proportions of:", 
                  x = -0.15, xref = 'paper', y = 0.93, yref = 'paper', 
                  showarrow = FALSE)
```


### Education x daily cost 

```{r}
## -- create function to make plot df -- ##
function_plot_education_dailyCost <- function(education_group, weighted_quartile,
                                              ridb_df = data_ridb_acs_2018){
  
  df <- ridb_df %>% 
    select(park, customer_zip, hs_GED_or_below, 
           some_college, college, master_or_above, daily_cost) %>% 
    drop_na(daily_cost) %>% 
  pivot_longer(cols = 3:6,
               names_to = "education",
               values_to = "education_percentage") %>% 
    filter(education == education_group) %>% 
    drop_na(education_percentage) %>% 
    filter(education_percentage >= weighted_quartile) %>% 
    summarize(median_daily_cost = median(daily_cost),
              quartile_lower = quantile(daily_cost)[[2]],
              quartile_upper = quantile(daily_cost)[[4]],
              count = n()) %>% 
    mutate(education = paste0(education_group)) %>% 
    relocate(education, .before = 1) %>%  
    mutate(education = str_replace_all(string = education,
                              pattern = "_",
                              replacement = " "),
           education = str_to_title(education),
           education = str_replace(string = education,
                                   pattern = "Hs Ged Or", 
                                   replacement = "HS, GED, or"),
           education = str_replace(string = education,
                                   pattern = "Some College",
                                   replacement = "Some College or Trade School"),
           education = str_replace(string = education,
                                   pattern = "^College$",
                                   replacement = "Associates or Bachelors Degree"),
           education = str_replace(string = education,
                                   pattern = "Master Or Above",
                                   replacement = "Masters Degree or Above"),
           education_y_lab = case_when(education == "HS, GED, or Below" ~ "HS, GED,\nor Below",
                                       education == "Some College or Trade School" ~ "Some College or\nTrade School",
                                       education == "Associates or Bachelors Degree" ~ "Associates or\nBachelors Degree",
                                       education == "Masters Degree or Above" ~ "Masters Degree\nor Above"),
           education_y_lab = factor(education_y_lab, levels = c("HS, GED,\nor Below", 
                                                    "Some College or\nTrade School", 
                                                    "Associates or\nBachelors Degree", 
                                                    "Masters Degree\nor Above")))
  
  return(df)
}
```

```{r}
## -- run function through purrr -- ##
data_plot_education_dailyCost <- 
  data_education_quants %>% 
  pmap_dfr(function_plot_education_dailyCost)


## -- create plot -- ##
# parameters
education_group_colors <- c("HS, GED,\nor Below" = "#a6cee3", "Some College or\nTrade School"  = "#1f78b4", 
                      "Associates or\nBachelors Degree" = "#b2df8a", "Masters Degree\nor Above" = "#33a02c")

# plotly
plot_education_daily_cost <- ggplot(data = data_plot_education_dailyCost, 
                                      aes(x = median_daily_cost,
                                          y = education_y_lab)) +
  geom_segment(aes(xend = 0, yend = education_y_lab)) +
  geom_point(aes(color = education_y_lab, fill = education_y_lab,
                 text = paste0(comma(count, accuracy = 1), 
                               " unique visits were made by people who live in ZIP codes with high rates of<br>",
                               education, 
                               " as the highest level of education. Typically these visitors<br>traveled between ",
                               comma(quartile_lower, accuracy = 1), 
                               " and ", comma(quartile_upper, accuracy = 1), 
                               " miles, with a median distance of ", 
                               comma(median_daily_cost, accuracy = 1), 
                               " miles.")),
             size = 3.5, 
             shape = 21, stroke = 2) +
  scale_x_continuous(labels = dollar) +
  scale_y_discrete(expand = c(0.35, 0)) +
  scale_fill_manual(values = education_group_colors) +
  scale_color_manual(values = education_group_colors) +
  labs(x = "Estimated Daily Cost per Reservation (US $)",
       y = "") + 
  theme_minimal() +
  theme(plot.background = element_rect("white"),
        panel.grid.major.y = element_blank(),
        legend.position = "none")

ggplotly(plot_education_daily_cost,
         tooltip = list("text")) %>%
  config(modeBarButtonsToRemove = list("pan", "select", "lasso2d", "autoScale2d", 
                                       "hoverClosestCartesian", "hoverCompareCartesian")) %>% 
    layout(title = list(text = paste0('<b>', siteInput, '<br>', admin_unitInput, '</b>',
                                      '<br>',
                                      'Daily Cost Paid by Visitors with Different Levels of Education'),
                        font = list(size = 15))) %>%  
  add_annotations(text = "Reservations from ZIP codes<br>with high proportions of:", 
                  x = -0.15, xref = 'paper', y = 0.93, yref = 'paper', 
                  showarrow = FALSE)
```


### Education x daily cost per visitor

```{r}
## -- create function to make plot df -- ##
function_plot_education_dailyCostPerVisitor <- function(education_group, weighted_quartile,
                                              ridb_df = data_ridb_acs_2018){
  
  df <- ridb_df %>% 
    select(park, customer_zip, hs_GED_or_below, 
           some_college, college, master_or_above, daily_cost_per_visitor) %>% 
    drop_na(daily_cost_per_visitor) %>% 
  pivot_longer(cols = 3:6,
               names_to = "education",
               values_to = "education_percentage") %>% 
    filter(education == education_group) %>% 
    drop_na(education_percentage) %>% 
    filter(education_percentage >= weighted_quartile) %>% 
    summarize(median_daily_cost_per_visitor = median(daily_cost_per_visitor),
              quartile_lower = quantile(daily_cost_per_visitor)[[2]],
              quartile_upper = quantile(daily_cost_per_visitor)[[4]],
              count = n()) %>% 
    mutate(education = paste0(education_group)) %>% 
    relocate(education, .before = 1) %>%  
    mutate(education = str_replace_all(string = education,
                              pattern = "_",
                              replacement = " "),
           education = str_to_title(education),
           education = str_replace(string = education,
                                   pattern = "Hs Ged Or", 
                                   replacement = "HS, GED, or"),
           education = str_replace(string = education,
                                   pattern = "Some College",
                                   replacement = "Some College or Trade School"),
           education = str_replace(string = education,
                                   pattern = "^College$",
                                   replacement = "Associates or Bachelors Degree"),
           education = str_replace(string = education,
                                   pattern = "Master Or Above",
                                   replacement = "Masters Degree or Above"),
           education_y_lab = case_when(education == "HS, GED, or Below" ~ "HS, GED,\nor Below",
                                       education == "Some College or Trade School" ~ "Some College or\nTrade School",
                                       education == "Associates or Bachelors Degree" ~ "Associates or\nBachelors Degree",
                                       education == "Masters Degree or Above" ~ "Masters Degree\nor Above"),
           education_y_lab = factor(education_y_lab, levels = c("HS, GED,\nor Below", 
                                                    "Some College or\nTrade School", 
                                                    "Associates or\nBachelors Degree", 
                                                    "Masters Degree\nor Above")))
  
  return(df)
}
```

```{r}
## -- run function through purrr -- ##
data_plot_education_dailyCostPerVisitor <- 
  data_education_quants %>% 
  pmap_dfr(function_plot_education_dailyCostPerVisitor)


## -- create plot -- ##
# parameters
education_group_colors <- c("HS, GED,\nor Below" = "#a6cee3", "Some College or\nTrade School"  = "#1f78b4", 
                      "Associates or\nBachelors Degree" = "#b2df8a", "Masters Degree\nor Above" = "#33a02c")

# plotly
plot_education_daily_cost <- ggplot(data = data_plot_education_dailyCostPerVisitor, 
                                      aes(x = median_daily_cost_per_visitor,
                                          y = education_y_lab)) +
  geom_segment(aes(xend = 0, yend = education_y_lab)) +
  geom_point(aes(color = education_y_lab, fill = education_y_lab,
                 text = paste0(comma(count, accuracy = 1), 
                               " unique visits were made by people who live in ZIP codes with high rates of<br>",
                               education, 
                               " as the highest level of education. Typically these visitors<br>traveled between ",
                               comma(quartile_lower, accuracy = 1), 
                               " and ", comma(quartile_upper, accuracy = 1), 
                               " miles, with a median distance of ", 
                               comma(median_daily_cost_per_visitor, accuracy = 1), 
                               " miles.")),
             size = 3.5, 
             shape = 21, stroke = 2) +
  scale_x_continuous(labels = dollar) +
  scale_y_discrete(expand = c(0.35, 0)) +
  scale_fill_manual(values = education_group_colors) +
  scale_color_manual(values = education_group_colors) +
  labs(x = "Estimated Daily Cost per Visitor (US $)",
       y = "") + 
  theme_minimal() +
  theme(plot.background = element_rect("white"),
        panel.grid.major.y = element_blank(),
        legend.position = "none")

ggplotly(plot_education_daily_cost,
         tooltip = list("text")) %>%
  config(modeBarButtonsToRemove = list("pan", "select", "lasso2d", "autoScale2d", 
                                       "hoverClosestCartesian", "hoverCompareCartesian")) %>% 
    layout(title = list(text = paste0('<b>', siteInput, '<br>', admin_unitInput, '</b>',
                                      '<br>',
                                      'Daily Cost per Visitor Paid by Visitors with Different Levels of Education'),
                        font = list(size = 15))) %>%  
  add_annotations(text = "Reservations from ZIP codes<br>with high proportions of:", 
                  x = -0.15, xref = 'paper', y = 0.93, yref = 'paper', 
                  showarrow = FALSE)
```



### Education x length of stay 

```{r}
## -- create function to make plot df -- ##
function_plot_education_lengthStay <- function(education_group, weighted_quartile,
                                              ridb_df = data_ridb_acs_2018){
  
  df <- ridb_df %>% 
    select(park, customer_zip, hs_GED_or_below, 
           some_college, college, master_or_above, length_of_stay) %>% 
    drop_na(length_of_stay) %>% 
  pivot_longer(cols = 3:6,
               names_to = "education",
               values_to = "education_percentage") %>% 
    filter(education == education_group) %>% 
    drop_na(education_percentage) %>% 
    filter(education_percentage >= weighted_quartile) %>% 
    summarize(median_length_of_stay = median(length_of_stay),
              quartile_lower = quantile(length_of_stay)[[2]],
              quartile_upper = quantile(length_of_stay)[[4]],
              count = n()) %>% 
    mutate(education = paste0(education_group)) %>% 
    relocate(education, .before = 1) %>%   
    mutate(education = str_replace_all(string = education,
                              pattern = "_",
                              replacement = " "),
           education = str_to_title(education),
           education = str_replace(string = education,
                                   pattern = "Hs Ged Or", 
                                   replacement = "HS, GED, or"),
           education = str_replace(string = education,
                                   pattern = "Some College",
                                   replacement = "Some College or Trade School"),
           education = str_replace(string = education,
                                   pattern = "^College$",
                                   replacement = "Associates or Bachelors Degree"),
           education = str_replace(string = education,
                                   pattern = "Master Or Above",
                                   replacement = "Masters Degree or Above"),
           education_y_lab = case_when(education == "HS, GED, or Below" ~ "HS, GED,\nor Below",
                                       education == "Some College or Trade School" ~ "Some College or\nTrade School",
                                       education == "Associates or Bachelors Degree" ~ "Associates or\nBachelors Degree",
                                       education == "Masters Degree or Above" ~ "Masters Degree\nor Above"),
           education_y_lab = factor(education_y_lab, levels = c("HS, GED,\nor Below", 
                                                    "Some College or\nTrade School", 
                                                    "Associates or\nBachelors Degree", 
                                                    "Masters Degree\nor Above")))
  
  return(df)
}
```

```{r}
## -- run function through purrr -- ##
data_plot_education_lengthStay <- 
  data_education_quants %>% 
  pmap_dfr(function_plot_education_lengthStay)


## -- create plot -- ##
# parameters
education_group_colors <- c("HS, GED,\nor Below" = "#a6cee3", "Some College or\nTrade School"  = "#1f78b4", 
                      "Associates or\nBachelors Degree" = "#b2df8a", "Masters Degree\nor Above" = "#33a02c")

# plotly
plot_education_daily_cost <- ggplot(data = data_plot_education_lengthStay, 
                                      aes(x = median_length_of_stay,
                                          y = education_y_lab)) +
  geom_segment(aes(xend = 0, yend = education_y_lab)) +
  geom_point(aes(color = education_y_lab, fill = education_y_lab,
                 text = paste0(comma(count, accuracy = 1), 
                               " unique visits were made by people who live in ZIP codes with<br>high rates of ",
                               education, 
                               " as the highest level of education.<br>Typically these visitor stay between ",
                               comma(quartile_lower, accuracy = 1), 
                               " and ", comma(quartile_upper, accuracy = 1), 
                               " days, with a median stay of ", 
                               comma(median_length_of_stay, accuracy = 1), 
                               " days")),
             size = 3.5, 
             shape = 21, stroke = 2) +
  scale_y_discrete(expand = c(0.35, 0)) +
  scale_fill_manual(values = education_group_colors) +
  scale_color_manual(values = education_group_colors) +
  labs(x = "Estimated Length of Stay (days)",
       y = "") + 
  theme_minimal() +
  theme(plot.background = element_rect("white"),
        panel.grid.major.y = element_blank(),
        legend.position = "none")

ggplotly(plot_education_daily_cost,
         tooltip = list("text")) %>%
  config(modeBarButtonsToRemove = list("pan", "select", "lasso2d", "autoScale2d", 
                                       "hoverClosestCartesian", "hoverCompareCartesian")) %>% 
    layout(title = list(text = paste0("<b>", siteInput, "<br>", admin_unitInput, "</b>",
                                      "<br>",
                                      "Length of Stay by Visitors with Different Levels of Education"),
                        font = list(size = 15))) %>%  
  add_annotations(text = "Reservations from ZIP codes<br>with high proportions of:", 
                  x = -0.15, xref = 'paper', y = 0.93, yref = 'paper', 
                  showarrow = FALSE)
```



## Language x ____

### High categories df

```{r }
# create function to get weighted quartile value for each group (in quartile function .R)
language_top_quartile <- function(language_group, acs_df = data_ca_acs_2018){
  
  df_ca_bin_breaks <- acs_df %>%
    select(zip_code, english_only, not_english_only, mean_zip_code_population) %>% 
    pivot_longer(cols = 2:3,
                 names_to = "language",
                 values_to = "language_percentage") %>% 
    filter(language == language_group) %>% 
    drop_na(language_percentage)
  
  weighted_half <- weighted.mean(x = df_ca_bin_breaks$language_percentage, w = df_ca_bin_breaks$mean_zip_code_population)
  
  df_ca_bin_breaks <- df_ca_bin_breaks %>% filter(language_percentage >= weighted_half)
  
  weighted_quartile <- weighted.mean(x = df_ca_bin_breaks$language_percentage, w = df_ca_bin_breaks$mean_zip_code_population)
  
  return(weighted_quartile)
}

## -- run function through purrr -- ##
language_group <- c("english_only", "not_english_only")

# quartile df (in server.R)
data_language_quants <- 
  language_group %>% 
  map_dbl(language_top_quartile) %>% 
  cbind("language_group" = language_group, 
        "weighted_quartile" = .) %>% 
  as.data.frame()
```


```{r}
## -- create plot showing numbers of reservations for each "high" racial group -- ##
function_plot_top_language_reservations <- function(language_group, weighted_quartile,
                                                    ridb_df = data_ridb_acs_2018){
  df <- ridb_df %>% 
    select(park, customer_zip, english_only, not_english_only) %>% 
    pivot_longer(cols = 3:4,
                 names_to = "language",
                 values_to = "language_percentage") %>% 
    filter(language == paste0(language_group)) %>% 
    drop_na(language_percentage) %>% 
    filter(language_percentage >= weighted_quartile) %>% 
    summarize(count = n()) %>% 
    mutate(language = paste0(language_group)) %>% 
    relocate(language, .before = 1) %>% 
    mutate(language = str_replace_all(string = language,
                              pattern = "_",
                              replacement = " "),
           language = str_replace(string = language,
                                  pattern = "^english only$",
                                  replacement = "Speak Only English at Home"),
           language = str_replace(string = language,
                                  pattern = "^not english only$",
                                  replacement = "Speak Language(s) Other Than English at Home"))
  
  return(df)
}

## -- run function through purrr -- ##
data_plot_top_language_reservations <- 
  data_language_quants %>% 
  pmap_dfr(function_plot_top_language_reservations) %>% 
  mutate(language = str_to_lower(language),
         language = str_replace(string = language,
                                pattern = "english",
                                replacement = "English"),
         language_y_axis = case_when(language == "speak only English at home" ~ "Speak Only<br>English At Home",
                                     language == "speak language(s) other than English at home" ~ "Speak Language(s) Other<br>Than English At Home"))
  


## -- create plotly -- ##
# parameters
language_group_colors <- c("Speak Only<br>English At Home" = "#66c2a5", "Speak Language(s) Other<br>Than English At Home" = "#8da0cb")

#plotly
plot <- ggplot(data = data_plot_top_language_reservations) +
  geom_col(aes(x = count,
               y = language_y_axis,
               fill = language_y_axis,
               text = paste0(comma(count, accuracy = 1), 
                             " reservations were made by people who live in ZIP codes<br>with high rates people who speak ", 
                             language, "."))) +
  scale_x_continuous(labels = comma) +
  scale_y_discrete(expand = c(0.9, 0)) +
  scale_fill_manual(values = language_group_colors) +
  scale_color_manual(values = language_group_colors) +
  labs(x = paste("Number of Reservations"),
       y = "",
       title = paste0("Number of Reservations by People from Communities with High Rates of <br> Languages Other than English Spoken at Home")) + 
  theme_minimal() +
  theme(plot.background = element_rect("white"),
        panel.grid.major.y = element_blank(),
        legend.position = "none")

ggplotly(plot,
         tooltip = list("text")) %>%
  config(modeBarButtonsToRemove = list("pan", "select", "lasso2d", "autoScale2d", 
                                       "hoverClosestCartesian", "hoverCompareCartesian")) %>% 
  add_annotations(text = "Reservations from ZIP codes<br>with high proportions of:", 
                  x = -0.15, xref = 'paper', y = 0.97, yref = 'paper', 
                  showarrow = FALSE)
```


### Language x distance traveled


```{r}
## -- create function to make plot df -- ##
function_plot_language_distanceTravel <- function(language_group, weighted_quartile,
                                              ridb_df = data_ridb_acs_2018){
  
  df <- ridb_df %>% 
    select(park, customer_zip, english_only, not_english_only,
           distance_traveled_m) %>% 
    mutate(distance_traveled_mi = distance_traveled_m * 0.000621371) %>% 
    drop_na(distance_traveled_mi) %>% 
    pivot_longer(cols = 3:4,
               names_to = "language",
               values_to = "language_percentage") %>% 
    filter(language == language_group) %>% 
    drop_na(language_percentage) %>% 
    filter(language_percentage >= weighted_quartile) %>% 
    summarize(median_distance_traveled_mi = median(distance_traveled_mi),
              quartile_lower = quantile(distance_traveled_mi)[[2]],
              quartile_upper = quantile(distance_traveled_mi)[[4]],
              count = n()) %>% 
    mutate(language = paste0(language_group)) %>% 
    relocate(language, .before = 1) %>% 
    mutate(language = str_replace_all(string = language,
                                      pattern = "_",
                                      replacement = " "),
           language = str_replace(string = language,
                                  pattern = "^english only$",
                                  replacement = "Speak Only English at Home"),
           language = str_replace(string = language,
                                  pattern = "^not english only$",
                                  replacement = "Speak Language(s) Other Than English at Home"),
           language = str_to_lower(language),
           language = str_replace(string = language,
                                  pattern = "english",
                                  replacement = "English"),
           language_y_lab = case_when(language == "speak only English at home" ~ "Speak Only<br>English At Home",
                                       language == "speak language(s) other than English at home" ~ "Speak Language(s) Other<br>Than English At Home"))
  
  return(df)
}
```


```{r}
## -- run function through purrr -- ##
data_plot_language_distanceTravel <- 
  data_language_quants %>% 
  pmap_dfr(function_plot_language_distanceTravel)


## -- create plot -- ##
# parameters
language_group_colors <- c("Speak Only<br>English At Home" = "#66c2a5", "Speak Language(s) Other<br>Than English At Home" = "#8da0cb")

# plotly
plot_education_distance_traveled <- ggplot(data = data_plot_language_distanceTravel, 
                                      aes(x = median_distance_traveled_mi,
                                          y = language_y_lab)) +
  geom_segment(aes(xend = 0, yend = language_y_lab)) +
  geom_point(aes(color = language_y_lab, fill = language_y_lab,
                 text = paste0(comma(count, accuracy = 1), 
                               " unique visits were made by people who live in ZIP codes with high rates of<br>people who speak ",
                               language, 
                               ". Typically these visitors<br>traveled between ",
                               comma(quartile_lower, accuracy = 1), 
                               " and ", comma(quartile_upper, accuracy = 1), 
                               " miles, with a median distance of ", 
                               comma(median_distance_traveled_mi, accuracy = 1), 
                               " miles.")),
             size = 3.5, 
             shape = 21, stroke = 2) +
  scale_y_discrete(expand_scale(mult = 0.1)) +
  scale_fill_manual(values = language_group_colors) +
  scale_color_manual(values = language_group_colors) +
  labs(x = paste("Estimated Distance Traveled from Home to Site (miles)"),
       y = "") + 
  theme_minimal() +
  theme(plot.background = element_rect("white"),
        panel.grid.major.y = element_blank(),
        legend.position = "none")

ggplotly(plot_education_distance_traveled,
         tooltip = list("text")) %>%
  config(modeBarButtonsToRemove = list("pan", "select", "lasso2d", "autoScale2d", 
                                       "hoverClosestCartesian", "hoverCompareCartesian")) %>% 
    layout(title = list(text = paste0('<b>', siteInput, '<br>', admin_unitInput, '</b>',
                                      '<br>',
                                      'Distance Traveled by Visitors with Different Home Lanugages'),
                        font = list(size = 15))) %>%  
  add_annotations(text = "Reservations from ZIP codes<br>with high proportions of:", 
                  x = -0.15, xref = 'paper', y = 0.9, yref = 'paper', 
                  showarrow = FALSE)
```

### Language x site type

```{r}
## -- create function to make plot df -- ##
function_plot_language_siteType <- function(language_group, weighted_quartile,
                                            ridb_df = data_ridb_acs_2018){
  
  df <- ridb_df %>% 
    select(park, customer_zip, english_only, not_english_only, aggregated_site_type) %>% 
    drop_na(aggregated_site_type) %>% 
    pivot_longer(cols = 3:4,
                 names_to = "language",
                 values_to = "language_percentage") %>% 
    filter(language == language_group) %>% 
    drop_na(language_percentage) %>% 
    filter(language_percentage >= weighted_quartile) %>% 
    count(language, aggregated_site_type) %>% 
    rename(count = n) %>% 
    mutate(language = paste0(language_group)) %>% 
    relocate(language, .before = 1) %>%
    mutate(language = str_replace_all(string = language,
                                      pattern = "_",
                                      replacement = " "),
           language = str_replace(string = language,
                                  pattern = "^english only$",
                                  replacement = "Speak Only English at Home"),
           language = str_replace(string = language,
                                  pattern = "^not english only$",
                                  replacement = "Speak Language(s) Other Than English at Home"),
           language = str_to_lower(language),
           language = str_replace(string = language,
                                  pattern = "english",
                                  replacement = "English"),
           language_y_lab = case_when(language == "speak only English at home" ~ "Speak Only<br>English At Home",
                                       language == "speak language(s) other than English at home" ~ "Speak Language(s) Other<br>Than English At Home"))
  
  return(df)
}
```

```{r}
## -- run function through purrr -- ##
data_plot_language_siteType <- 
  data_language_quants %>% 
  pmap_dfr(function_plot_language_siteType)

## -- create plot -- ##

# parameters
language_group_colors <- c("Speak Only<br>English At Home" = "#66c2a5", "Speak Language(s) Other<br>Than English At Home" = "#8da0cb")

# subset data to site type category
site_type_categories <- c("equestrian", "remote", "rv only", "rv or tent", "shelter", "tent only", "water")

data_plot_language_siteType_category <- data_plot_language_siteType %>% 
  filter(aggregated_site_type == site_type_categories[[1]]) %>% 
  mutate(aggregated_site_type = str_to_title(aggregated_site_type),
         aggregated_site_type = str_replace(string = aggregated_site_type,
                                            pattern = "Rv", 
                                            replacement = "RV"))

# plotly
plot_language_site_type <- ggplot(data = data_plot_language_siteType_category) +
  geom_col(aes(x = count,
               y = language_y_lab,
               fill = language_y_lab,
               text = paste0("Of visits to ", aggregated_site_type, " overnight reservable sites, ", 
                             comma(count, accuracy = 1), 
                             " reservations were made by <br>people who live in ZIP codes with high rates of people who speak ",
                               language, "."))) +
  scale_y_discrete(expand = c(0.9, 0)) +
  scale_fill_manual(values = language_group_colors) +
  scale_color_manual(values = language_group_colors) +
  labs(x = paste("Number of Reservations"),
       y = "") + 
  theme_minimal() +
  theme(plot.background = element_rect("white"),
        panel.grid.major.y = element_blank(),
        legend.position = "none")


ggplotly(plot_language_site_type,
         tooltip = list("text")) %>%
  config(modeBarButtonsToRemove = list("pan", "select", "lasso2d", "autoScale2d", 
                                       "hoverClosestCartesian", "hoverCompareCartesian")) %>% 
  layout(title = list(text = paste0('<b>', siteInput, '<br>', admin_unitInput, '</b>',
                                    '<br>',
                                    "Number of Reservations to ", str_to_title(site_type_categories[[1]]) %>%
                                      str_replace(string = ., pattern = "Rv", replacement = "RV"), 
                                    " Sites by Visitors with Different Languages"),
                      font = list(size = 15))) %>%  
  add_annotations(text = "Reservations from ZIP codes<br>with high proportions of:", 
                  x = -0.15, xref = 'paper', y = 0.93, yref = 'paper', 
                  showarrow = FALSE)
```







```{r}
## -- create function to make plot df -- ##

```

```{r}
## -- run function through purrr -- ##

## -- create plot -- ##

# parameters

# plotly
```

```{r, eval=TRUE}
end_time <- Sys.time()
time_taken <- end_time - start_time
time_taken
```




```{r}
## -- parallel processsing code if we need it -- ##

# race_group <- c("other", "pacific_islander", "multiracial", "asian", 
#                    "black", "white", "native_american", "hispanic_latinx")
# # parallel processing
# # n_cores <- detectCores() - 1
# # plan(multisession, workers = n_cores)
# 
# # quartile df (in server.R)
# data_race_distanceTraveled_high <- 
#   race_group %>% 
#   map_dbl(function_highCutoff) %>% 
#   cbind("race_group" = race_group, 
#         "weighted_quartile" = .) %>% 
#   as.data.frame()
# 
# # race group df
# data_plot_race_distanceTravel <-  #{
#   data_race_distanceTraveled_high %>% pmap_dfr(function_plot_race_distanceTravel)
# #}
# # data_plot_race_siteType <- #{
# #   data_race_distance_traveled_high %>% pmap_dfr(function_plot_race_siteType)
# #}
# 
# #gc()
```

