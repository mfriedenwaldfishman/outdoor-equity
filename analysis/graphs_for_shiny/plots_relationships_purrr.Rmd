---
title: "Trying out purr for plot functions"
author: "Clarissa"
date: "4/19/2022"
output: html_document
---

```{r setup, include=FALSE, eval=TRUE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)

library(tidyverse)
library(here)
library(janitor)
library(tidycensus)
library(scales)
library(vroom)
library(plotly)
library(furrr)
library(parallel)
library(future)

admin_unitInput <- "National Park/Forest/Etc."
siteInput <- "Best Site Ever"
```

```{r, eval=TRUE}
start_time <- Sys.time()
```

```{r, eval=TRUE}
# read in joined data
data_ridb_acs_2018 <- vroom(file = "../../../../data_clean/2018_joined_data.csv",
                            delim = ",") ## non-map graphs (no geometries)
# data_ridb_acs_2018 <- readRDS(file = "../../../../data_clean/2018_joined_data.rds") ## maps (don't use RDS for non-map viz, too slow)

# read in CA ACS data for 2018
data_ca_acs_2018 <- vroom(file = "../../../../data_clean/2018_ca_acs_all.csv",
                          delim = ",")
```

## Race x ____

```{r, eval=TRUE}
# create function to get weighted quartile value for each group (in quartile function .R)
race_top_quartile <- function(race_group, acs_df = data_ca_acs_2018){
  
  df_ca_bin_breaks <- acs_df %>%
    select(zip_code, asian, black, hispanic_latinx, multiracial,
           native_american, other, pacific_islander, white, mean_zip_code_population) %>%
    pivot_longer(cols = 2:9,
                 names_to = "race",
                 values_to = "race_percentage") %>%
    filter(race == race_group) %>% 
    drop_na(race_percentage)
  
  weighted_half <- weighted.mean(x = df_ca_bin_breaks$race_percentage, w = df_ca_bin_breaks$mean_zip_code_population)
  
  df_ca_bin_breaks <- df_ca_bin_breaks %>% filter(race_percentage >= weighted_half)
  
  weighted_quartile <- weighted.mean(x = df_ca_bin_breaks$race_percentage, w = df_ca_bin_breaks$mean_zip_code_population)
  
  return(weighted_quartile)
}

## -- run function through purrr -- ##
race_group <- c("other", "pacific_islander", "multiracial", "asian", 
                "black", "white", "native_american", "hispanic_latinx")

# quartile df (in server.R)
data_race_quants <- 
  race_group %>% 
  map_dbl(race_top_quartile) %>% 
  cbind("race_group" = race_group, 
        "weighted_quartile" = .) %>% 
  as.data.frame()
```


### Race x distance traveled

```{r}
## -- create function to make plot df -- ##
function_plot_race_distanceTravel <- function(race_group, weighted_quartile,
                                              ridb_df = data_ridb_acs_2018){
  
  df <- ridb_df %>% 
    select(park, customer_zip, asian, black, hispanic_latinx, 
           multiracial, native_american, other, pacific_islander, white,
           distance_traveled_m) %>% 
    mutate(distance_traveled_mi = distance_traveled_m * 0.000621371) %>% 
    drop_na(distance_traveled_mi) %>% 
    pivot_longer(cols = 3:10,
                 names_to = "race",
                 values_to = "race_percentage") %>% 
    filter(race == paste0(race_group)) %>% 
    drop_na(race_percentage) %>% 
    filter(race_percentage >= weighted_quartile) %>% 
    summarize(median_distance_traveled_mi = median(distance_traveled_mi),
              quartile_lower = quantile(distance_traveled_mi)[[2]],
              quartile_upper = quantile(distance_traveled_mi)[[4]],
              count = n()) %>% 
    mutate(race = paste0(race_group)) %>% 
    relocate(race, .before = 1) %>% 
    mutate(race = str_replace(string = race,
                              pattern = "_",
                              replacement = " "),
           race = str_to_title(race),
           race = str_replace(string = race,
                              pattern = "Other",
                              replacement = "Other Race(s)"))
  
  return(df)
}
```


```{r}
## -- run function through purrr -- ##
data_plot_race_distanceTravel <- 
  data_race_quants %>% 
  pmap_dfr(function_plot_race_distanceTravel)


## -- create plot -- ##
# parameters
race_group_colors <- c("Other Race(s)" = "#999999", "Pacific Islander" = "#E69F00", "Multiracial" = "#56B4E9",
                       "Asian" = "#009E73", "Black" = "#F0E442", "White" = "#0072B2", 
                       "Native American" = "#D55E00", "Hispanic Latinx" = "#CC79A7")

# plotly
plot_race_distance_traveled <- ggplot(data = data_plot_race_distanceTravel, 
                                      aes(x = median_distance_traveled_mi,
                                          y = reorder(race, median_distance_traveled_mi))) +
  geom_segment(aes(xend = 0, yend = race)) +
  geom_point(aes(color = race, fill = race,
                 text = paste0(comma(count, accuracy = 1), 
                               " unique visits were made by people who live in ZIP codes<br>with high ",
                               str_to_title(race) %>% 
                                 str_replace(string = ., pattern = "\\(S\\)", "\\(s\\)"), 
                               " populations. Typically folks traveled between<br>",
                               comma(quartile_lower, accuracy = 1), 
                               " and ", comma(quartile_upper, accuracy = 1), 
                               " miles, with a median distance of ", 
                               comma(median_distance_traveled_mi, accuracy = 1), 
                               " miles.")),
             size = 3.5, 
             shape = 21, stroke = 2) +
  scale_y_discrete(expand = c(0.3, 0)) +
  scale_fill_manual(values = race_group_colors) +
  scale_color_manual(values = race_group_colors) +
  annotate(geom = "text", 
           x = 50, y = 9,
           label = "Reservations from ZIP codes with high proportions of:") +
  labs(x = paste("Estimated Distance Traveled from Home to Site (miles)"),
       y = "",
       title = paste0("Distance Traveled by Different Racial Groups to<br>", 
                      siteInput, ", ", admin_unitInput, " in 2018")) + 
  theme_minimal() +
  theme(plot.background = element_rect("white"),
        panel.grid.major.y = element_blank(),
        legend.position = "none")

ggplotly(plot_race_distance_traveled,
         tooltip = list("text")) %>%
  config(modeBarButtonsToRemove = list("pan", "select", "lasso2d", "autoScale2d", 
                                       "hoverClosestCartesian", "hoverCompareCartesian"))
```


### Race x site type 

```{r}
## -- create function to make plot df -- ##
function_plot_race_siteType <- function(race_group, weighted_quartile,
                                        ridb_df = data_ridb_acs_2018){
  
  df_racial_group <- ridb_df %>% 
    select(agency, admin_unit, park, customer_zip, asian, black, hispanic_latinx, 
           multiracial, native_american, other, pacific_islander, white,
           aggregated_site_type) %>% 
    drop_na(aggregated_site_type) %>% 
    pivot_longer(cols = 5:12,
                 names_to = "race",
                 values_to = "race_percentage") %>% 
    filter(race == paste0(race_group)) %>%
    drop_na(race_percentage) %>%
    filter(race_percentage >= weighted_quartile) %>% 
    count(race, aggregated_site_type) %>% 
    rename(count = n) %>% 
    mutate(race = paste0(race_group)) %>%
    relocate(race, .before = 1) %>% 
    mutate(race = str_replace(string = race,
                              pattern = "_",
                              replacement = " "),
           race = str_to_title(race),
           race = str_replace(string = race,
                              pattern = "Other",
                              replacement = "Other Race(s)"))
  
  return(df_racial_group)
}
```


```{r}
## -- run function through purrr -- ##
data_plot_race_siteType <- 
  data_race_quants %>% 
  pmap_dfr(function_plot_race_siteType)


## -- create plot -- ##
# parameters
race_group_colors <- c("Other Race(s)" = "#999999", "Pacific Islander" = "#E69F00", "Multiracial" = "#56B4E9",
                       "Asian" = "#009E73", "Black" = "#F0E442", "White" = "#0072B2", 
                       "Native American" = "#D55E00", "Hispanic Latinx" = "#CC79A7")

# subset data to site type category
site_type_categories <- c("equestrian", "remote", "rv only", "rv or tent", "shelter", "tent only", "water")

data_plot_race_siteType_category <- data_plot_race_siteType %>% 
  filter(aggregated_site_type == site_type_categories[[1]]) %>% 
  mutate(aggregated_site_type = str_to_title(aggregated_site_type),
         aggregated_site_type = str_replace(string = aggregated_site_type,
                                            pattern = "Rv", 
                                            replacement = "RV"))

# create plot
plot_race_site_type_equestrian <- 
  ggplot(data = data_plot_race_siteType_category) +
  geom_col(aes(x = count,
               y = reorder(race, count),
               fill = race,
               text = paste0("Of visits to ", aggregated_site_type, " overnight reservable sites, ", 
                             comma(count, accuracy = 1), 
                             " reservations were made by <br>people who live in ZIP codes with high ", 
                             race, " populations."))) +
  scale_y_discrete(expand = c(0.3, 0)) +
  scale_fill_manual(values = race_group_colors) +
  scale_color_manual(values = race_group_colors) +
  labs(x = paste("Number of Reservations"),
       y = "",
       title = paste0("Number of Reservations to ", str_to_title(site_type_categories[[1]]) %>% 
                            str_replace(string = ., pattern = "Rv", replacement = "RV"),
                      " Sites by <br> People from Communities with High Rates of Different Racial Groups")) + 
  annotate(geom = "text", 
           x = 200, y = 9,
           label = "Reservations from ZIP codes with high proportions of:") +
  theme_minimal() +
  theme(plot.background = element_rect("white"),
        panel.grid.major.y = element_blank(),
        legend.position = "none")

ggplotly(plot_race_site_type_equestrian,
         tooltip = list("text")) %>%
  config(modeBarButtonsToRemove = list("pan", "select", "lasso2d", "autoScale2d", 
                                       "hoverClosestCartesian", "hoverCompareCartesian"))
```



### Race x booking window 

```{r}
## -- create function to make plot df -- ##
function_plot_race_bookWindow <- function(race_group, weighted_quartile,
                                        ridb_df = data_ridb_acs_2018){
  
  df_race_group <- ridb_df %>% 
    select(park, customer_zip, asian, black, hispanic_latinx, 
           multiracial, native_american, other, pacific_islander, white,
           booking_window) %>% 
    drop_na(booking_window) %>% 
    pivot_longer(cols = 3:10,
                 names_to = "race",
                 values_to = "race_percentage") %>% 
    filter(race == race_group) %>%
    drop_na(race_percentage) %>% 
    filter(race_percentage >= weighted_quartile) %>% 
    summarize(median_booking_window = median(booking_window)) %>% 
    mutate(race = paste0(race_group)) %>%  ## BACK TO i
    relocate(race, .before = 1) %>% 
    mutate(race = str_replace(string = race,
                              pattern = "_",
                              replacement = " "),
           race = str_to_title(race),
           race = str_replace(string = race,
                              pattern = "Other",
                              replacement = "Other Race(s)"))
  
  return(df_race_group)
}
```

```{r}
## -- run function through purrr -- ##
data_plot_race_bookWindow <- 
  data_race_quants %>% 
  pmap_dfr(function_plot_race_bookWindow)

## -- create plot -- ##
# parameters
race_group_colors <- c("Other Race(s)" = "#999999", "Pacific Islander" = "#E69F00", "Multiracial" = "#56B4E9",
                              "Asian" = "#009E73", "Black" = "#F0E442", "White" = "#0072B2", 
                              "Native American" = "#D55E00", "Hispanic Latinx" = "#CC79A7")

# plotly
plot_race_booking_window <- ggplot(data = data_plot_race_bookWindow, 
                                      aes(x = median_booking_window,
                                          y = reorder(race, median_booking_window))) +
  geom_segment(aes(xend = 0, yend = race)) +
  geom_point(aes(x = median_booking_window,
                 y = reorder(race, median_booking_window),
                 color = race, fill = race,
                 text = paste("People who live in ZIP codes with high", 
                              str_to_title(race) %>% str_replace(string = ., pattern = "\\(S\\)", "\\(s\\)"), 
                              "populations",
                             "<br>tend to make their reservations", round(median_booking_window, 0), "days before their visit to overnight reservable sites.")),
             width = .25,
             size = 4, shape = 21, stroke = 2) +
  scale_fill_manual(values = race_group_colors) +
  scale_color_manual(values = race_group_colors) +
  labs(x = paste("Average Number of Days from Order Date to Reservation Date"),
       y = "",
       title = "Average Number of Days in Advance <br>Reservation is Booked for Different Racial Groups") + 
  theme_minimal() +
  theme(plot.background = element_rect("white"),
        panel.grid.major.y = element_blank(),
        legend.position = "none")

ggplotly(plot_race_booking_window,
         tooltip = list("text"))
```











```{r}
## -- create function to make plot df -- ##

```

```{r}
## -- run function through purrr -- ##

## -- create plot -- ##

# parameters

# plotly
```


```{r, eval=TRUE}
end_time <- Sys.time()
time_taken <- end_time - start_time
time_taken
```




```{r}
## -- parallel processsing code if we need it -- ##

# race_group <- c("other", "pacific_islander", "multiracial", "asian", 
#                    "black", "white", "native_american", "hispanic_latinx")
# # parallel processing
# # n_cores <- detectCores() - 1
# # plan(multisession, workers = n_cores)
# 
# # quartile df (in server.R)
# data_race_distanceTraveled_high <- 
#   race_group %>% 
#   map_dbl(function_highCutoff) %>% 
#   cbind("race_group" = race_group, 
#         "weighted_quartile" = .) %>% 
#   as.data.frame()
# 
# # race group df
# data_plot_race_distanceTravel <-  #{
#   data_race_distanceTraveled_high %>% pmap_dfr(function_plot_race_distanceTravel)
# #}
# # data_plot_race_siteType <- #{
# #   data_race_distance_traveled_high %>% pmap_dfr(function_plot_race_siteType)
# #}
# 
# #gc()
```

