---
title: "Mock up of 'Data Relationships'"
author: "Clarissa"
date: "4/12/2022"
output: 
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(tidyverse)
library(here)
library(janitor)
library(lubridate)
library(sf)
library(tidycensus)
library(patchwork)
library(scales)
library(tmap)
library(vroom)
library(paletteer)
library(ggridges)
library(plotly)

options(scipen = 999)
```

```{r}
start_time <- Sys.time()
```

```{r}
# read in joined data
data_ridb_acs_2018 <- vroom(file = "../../../../data_clean/2018_joined_data.csv",
                            delim = ",") ## non-map graphs (no geometries)
# data_ridb_acs_2018 <- readRDS(file = "../../../../data_clean/2018_joined_data.rds") ## maps (don't use RDS for non-map viz, too slow)

data_ca_acs_2018 <- vroom(file = "../../../../data_clean/2018_ca_acs_all.csv",
                          delim = ",")
```

### Race x distance traveled


Checking myself on weighted quartiles:

```{r, eval=FALSE}
# print "high" for each race
print(paste0("A high presence was calculated as the highest quintile for each racial group for the state of California.   ",
             "White: ", round(top_quartile_ca_white, 4)*100, " - ", round(max_race_ridb_white, 4) *100, "%    ",
             "Hispanic Latinx: ", round(top_quartile_ca_hispanic_latinx, 4)*100, " - ", round(max_race_ridb_hispanic_latinx, 4) *100, "%    ",
             "Asian: ", round(top_quartile_ca_asian, 4)*100, " - ", round(max_race_ridb_asian, 4) *100, "%    ",
             "Black: ", round(top_quartile_ca_black, 4)*100, " - ", round(max_race_ridb_black, 4) *100, "%    ",
             "Multiracial: ", round(top_quartile_ca_multiracial, 4)*100, " - ", round(max_race_ridb_multiracial, 4) *100, "%    ",
             "Native American: ", round(top_quartile_native_ca_american, 4)*100, " - ", round(max_race_ridb_native_american, 4) *100, "%    ",
             "Pacific Islander: ", round(top_quartile_ca_pacific_islander, 4)*100, " - ", round(max_race_ridb_pacific_islander, 4) *100, "%    ",
             "Other Race(s): ", round(top_quartile_ca_other, 4)*100, " - ", round(max_race_ridb_other, 4) *100, "%  "))
```


```{r, eval=FALSE}
# check # of reservations in each "high" race categories
test_df <- data_plot_race_site_type

test_white <- test_df %>% filter(race == "White")
test_white <- sum(test_white$n)
test_hisp_lat <- test_df %>% filter(race == "Hispanic Latinx")
test_hisp_lat <- sum(test_hisp_lat$n)
test_asian <- test_df %>% filter(race == "Asian")
test_asian <- sum(test_asian$n)
test_black <- test_df %>% filter(race == "Black")
test_black <- sum(test_black$n)
test_multiracial <- test_df %>% filter(race == "Multiracial")
test_multiracial <- sum(test_multiracial$n)
test_nat_am <- test_df %>% filter(race == "Native American")
test_nat_am <- sum(test_nat_am$n)
test_pac_isl <- test_df %>% filter(race == "Pacific Islander")
test_pac_isl <- sum(test_pac_isl$n)
test_other <- test_df %>% filter(race == "Other Race(s)")
test_other <- sum(test_other$n)
test <- c("white" = test_white, "hispanic_latinx" = test_hisp_lat, "asian" = test_asian, "black" = test_black, "multiracial" = test_multiracial, "native_american" = test_nat_am, "pacific_islander" = test_pac_isl, "other" = test_other)

comma(test)
```


```{r}
## -- data wrangle -- ##
racial_groups <- c("other", "pacific_islander", "multiracial", "asian", 
                   "black", "white", "native_american", "hispanic_latinx")

data_plot_race_distance_traveled <- data.frame()

# create plot df for each group for RIDB data
for (i in seq_along(racial_groups)){
  df_ca_bin_breaks <- data_ca_acs_2018 %>% 
    select(zip_code, asian, black, hispanic_latinx, multiracial, 
           native_american, other, pacific_islander, white, mean_zip_code_population) %>% 
    pivot_longer(cols = 2:9,
                 names_to = "race",
                 values_to = "race_percentage") %>% 
    filter(race == racial_groups[[i]]) %>% ## BACK TO i
    drop_na(race_percentage) 
  
  weighted_half <- weighted.mean(x = df_ca_bin_breaks$race_percentage, w = df_ca_bin_breaks$mean_zip_code_population)
  
  df_ca_bin_breaks <- df_ca_bin_breaks %>% filter(race_percentage >= weighted_half)
  
  weighted_quartile <- weighted.mean(x = df_ca_bin_breaks$race_percentage, w = df_ca_bin_breaks$mean_zip_code_population)
  
  df_racial_group_i_longer <- data_ridb_acs_2018 %>% 
    select(agency, admin_unit, park, customer_zip, asian, black, hispanic_latinx, 
           multiracial, native_american, other, pacific_islander, white,
           distance_traveled_m) %>% 
    mutate(distance_traveled_mi = distance_traveled_m * 0.000621371) %>% 
    drop_na(distance_traveled_mi) %>% 
  pivot_longer(cols = 5:12,
               names_to = "race",
               values_to = "race_percentage") %>% 
    filter(race == racial_groups[[i]]) %>% ## BACK TO i
    drop_na(race_percentage)
  
  max_racial_group_ridb <- df_racial_group_i_longer %>%
    summarize(max = max(race_percentage))
  
  df_racial_i_group <- df_racial_group_i_longer %>% 
    filter(race_percentage >= weighted_quartile) %>% 
    summarize(mean_distance_traveled_mi = mean(distance_traveled_mi)) %>% 
    mutate(race = paste0(racial_groups[[i]])) %>%  ## BACK TO i
    relocate(race, .before = 1) %>% 
    mutate(race = str_replace(string = race,
                              pattern = "_",
                              replacement = " "),
           race = str_to_title(race),
           race = str_replace(string = race,
                              pattern = "Other",
                              replacement = "Other Race(s)"))

  data_plot_race_distance_traveled <- rbind(data_plot_race_distance_traveled, df_racial_i_group)
    
assign(paste0("top_quartile_ca_", racial_groups[[i]]), 
       c(weighted_quartile), 
       envir = .GlobalEnv)
assign(paste0("max_race_ridb_", racial_groups[[i]]), 
       data.frame(max_racial_group_ridb), 
       envir = .GlobalEnv)
}


## -- create plot -- ##
racial_group_colors <- c("Other Race(s)" = "#999999", "Pacific Islander" = "#E69F00", "Multiracial" = "#56B4E9",
                              "Asian" = "#009E73", "Black" = "#F0E442", "White" = "#0072B2", 
                              "Native American" = "#D55E00", "Hispanic Latinx" = "#CC79A7")


# plot for shiny
plot_race_distance_traveled <- ggplot(data = data_plot_race_distance_traveled, 
                                      aes(x = mean_distance_traveled_mi,
                                          y = reorder(race, mean_distance_traveled_mi))) +
  geom_segment(aes(xend = 0, yend = race)) +
  geom_point(aes(x = mean_distance_traveled_mi,
                 y = reorder(race, mean_distance_traveled_mi),
                 color = race, fill = race,
                 text = paste("People who live in ZIP codes with high", 
                              str_to_title(race) %>% str_replace(string = ., pattern = "\\(S\\)", "\\(s\\)"), "populations",
                             "<br>travel an estimated distance of", round(mean_distance_traveled_mi, 0), "miles.")),
             width = .25,
             size = 4, shape = 21, stroke = 2) +
  scale_fill_manual(values = racial_group_colors) +
  scale_color_manual(values = racial_group_colors) +
  labs(x = paste("Average Distance Traveled from Home to Site (miles)"),
       y = "",
       title = "Average Distance Traveled to Reservation for <br>Different Racial Groups") + 
  theme_minimal() +
  theme(plot.background = element_rect("white"),
        panel.grid.major.y = element_blank(),
        legend.position = "none")

ggplotly(plot_race_distance_traveled,
         tooltip = list("text"))
```


### Race x site type 

```{r}
## -- data wrangle -- ##
racial_groups <- c("other", "pacific_islander", "multiracial", "asian", 
                   "black", "white", "native_american", "hispanic_latinx")
site_types_groups <- c("equestrian", "remote", "rv only", "rv or tent", "shelter", "tent only", "water")

data_plot_race_site_type <- data.frame()

# create plot df for each group for RIDB data
for (i in seq_along(racial_groups)){
  df_ca_bin_breaks <- data_ca_acs_2018 %>% 
    select(zip_code, asian, black, hispanic_latinx, multiracial, 
           native_american, other, pacific_islander, white, mean_zip_code_population) %>% 
    pivot_longer(cols = 2:9,
                 names_to = "race",
                 values_to = "race_percentage") %>% 
    filter(race == racial_groups[[i]]) %>% ## BACK TO i
    drop_na(race_percentage) 
  
  weighted_half <- weighted.mean(x = df_ca_bin_breaks$race_percentage, w = df_ca_bin_breaks$mean_zip_code_population)
  
  df_ca_bin_breaks <- df_ca_bin_breaks %>% filter(race_percentage >= weighted_half)
  
  weighted_quartile <- weighted.mean(x = df_ca_bin_breaks$race_percentage, w = df_ca_bin_breaks$mean_zip_code_population)
  
  df_racial_group_i_longer <- data_ridb_acs_2018 %>% 
    select(agency, admin_unit, park, customer_zip, asian, black, hispanic_latinx, 
           multiracial, native_american, other, pacific_islander, white,
           aggregated_site_type) %>% 
    drop_na(aggregated_site_type) %>% 
    pivot_longer(cols = 5:12,
                 names_to = "race",
                 values_to = "race_percentage") %>% 
    filter(race == racial_groups[[i]]) %>% ## BACK TO i
    drop_na(race_percentage)
  
  max_racial_group_ridb <- df_racial_group_i_longer %>%
    summarize(max = max(race_percentage))
  
  df_racial_i_group <- df_racial_group_i_longer %>% 
    filter(race_percentage >= weighted_quartile) %>% 
    count(race, aggregated_site_type) %>% 
    mutate(race = paste0(racial_groups[[i]])) %>%  ## BACK TO i
    relocate(race, .before = 1) %>% 
    mutate(race = str_replace(string = race,
                              pattern = "_",
                              replacement = " "),
           race = str_to_title(race),
           race = str_replace(string = race,
                              pattern = "Other",
                              replacement = "Other Race(s)"))
  
  data_plot_race_site_type <- rbind(data_plot_race_site_type, df_racial_i_group)
  
  for (j in seq_along(site_types_groups)){
    site_df <- data_plot_race_site_type %>% 
      filter(aggregated_site_type == site_types_groups[[j]]) %>% 
      mutate(sum_n = sum(n),
             percent_n = n / sum_n)
    
    assign(paste0("data_plot_race_site_type_", 
                  str_replace_all(string = site_types_groups[[j]],
                                  pattern = " ",
                                  replacement = ".")),
           data.frame(site_df), envir = .GlobalEnv)
  }
  
  assign(paste0("top_quartile_ca_", racial_groups[[i]]), 
         c(weighted_quartile), 
         envir = .GlobalEnv)
  assign(paste0("max_race_ridb_", racial_groups[[i]]), 
         data.frame(max_racial_group_ridb), 
         envir = .GlobalEnv)
}


## -- create plot -- ##
racial_group_colors <- c("Other Race(s)" = "#999999", "Pacific Islander" = "#E69F00", "Multiracial" = "#56B4E9",
                              "Asian" = "#009E73", "Black" = "#F0E442", "White" = "#0072B2", 
                              "Native American" = "#D55E00", "Hispanic Latinx" = "#CC79A7")


# plot for shiny

# stacked all sites in one plot
data_plot_race_site_type <- rbind(data_plot_race_site_type_equestrian, data_plot_race_site_type_remote,
                                  data_plot_race_site_type_rv.only, data_plot_race_site_type_rv.or.tent,
                                  data_plot_race_site_type_shelter, data_plot_race_site_type_tent.only,
                                  data_plot_race_site_type_water) %>% 
  mutate(race = factor(race, levels = c("White", "Hispanic Latinx", "Asian", 
                                        "Black", "Multiracial", "Native American",
                                        "Pacific Islander", "Other Race(s)")),
         aggregated_site_type = str_to_title(string = aggregated_site_type) %>% 
           str_replace(string = ., pattern = "Rv", replacement = "RV"))

plot_race_site_type <- ggplot(data = data_plot_race_site_type, 
                              aes(x = percent_n,
                                  y = aggregated_site_type, fill = fct_rev(race),
                                  text = paste0("Of visits to ", aggregated_site_type, " sites, ", scales::percent(percent_n, accuracy = 0.01),
                                                " reservations were made by <br>people who live in ZIP codes with high ", 
                                                str_to_title(race) %>% str_replace(string = ., pattern = "\\(S\\)", "\\(s\\)"), " populations."))) +
  geom_col(position = "stack") +
  scale_fill_manual(values = racial_group_colors) +
  scale_x_continuous(labels = scales::percent) +
  labs(x = paste("Percent of Total Reservations per Site Type Group"),
       y = "",
       title = paste0("Percentage of Reservations to Sites by <br>Different Racial Groups")) + 
  theme_minimal() +
  theme(plot.background = element_rect("white"),
        panel.grid.major.y = element_blank(),
        legend.position = "none")

ggplotly(plot_race_site_type,
         tooltip = list("text"))
```

```{r}
# equestrian
data <- data_plot_race_site_type_equestrian
data_string <- deparse(substitute(data_plot_race_site_type_equestrian))

plot_race_site_type_equestrian <- ggplot(data = data, 
                                      aes(x = percent_n,
                                          y = reorder(race, percent_n))) +
  geom_segment(aes(xend = 0, yend = reorder(race, percent_n))) +
  geom_point(aes(x = percent_n,
                 y = reorder(race, percent_n),
                 color = race, fill = race,
                 text = paste0("Of visits to ", aggregated_site_type, " sites, ", scales::comma(round(percent_n, 4)*100, accuracy = 1),
                              "% reservations were made by <br>people who live in ZIP codes with high ", 
                              str_to_title(race) %>% str_replace(string = ., pattern = "\\(S\\)", "\\(s\\)"), " populations.")),
             width = .25,
             size = 4, shape = 21, stroke = 2) +
  scale_fill_manual(values = racial_group_colors) +
  scale_color_manual(values = racial_group_colors) +
  scale_x_continuous(labels = scales::percent) +
  labs(x = paste("Percent of Total", 
                 str_remove(string = data_string, pattern = ".*_") %>% 
                   str_replace_all(string = ., pattern = "\\.", replacement = " ") %>%  
                   str_to_title() %>% 
                   str_replace(string = ., pattern = "Rv", replacement = "RV"), 
                 "Reservations"),
       y = "",
       title = paste0("Percentage of Reservations to ", 
                      str_remove(string = data_string, pattern = ".*_") %>% 
                        str_replace_all(string = ., pattern = "\\.", replacement = " ") %>%  
                        str_to_title() %>% 
                        str_replace(string = ., pattern = "Rv", replacement = "RV"),
                      " Sites by <br>Different Racial Groups")) + 
  theme_minimal() +
  theme(plot.background = element_rect("white"),
        panel.grid.major.y = element_blank(),
        legend.position = "none")

ggplotly(plot_race_site_type_equestrian,
         tooltip = list("text"))
```

```{r}
# remote
data <- data_plot_race_site_type_remote
data_string <- deparse(substitute(data_plot_race_site_type_remote))

plot_race_site_type_remote <- ggplot(data = data, 
                                      aes(x = percent_n,
                                          y = reorder(race, percent_n))) +
  geom_segment(aes(xend = 0, yend = reorder(race, percent_n))) +
  geom_point(aes(x = percent_n,
                 y = reorder(race, percent_n),
                 color = race, fill = race,
                 text = paste0("Of visits to ", aggregated_site_type, " sites, ", scales::comma(round(percent_n, 4)*100, accuracy = 1),
                              "% reservations were made by <br>people who live in ZIP codes with high ", 
                              str_to_title(race) %>% str_replace(string = ., pattern = "\\(S\\)", "\\(s\\)"), " populations.")),
             width = .25,
             size = 4, shape = 21, stroke = 2) +
  scale_fill_manual(values = racial_group_colors) +
  scale_color_manual(values = racial_group_colors) +
  scale_x_continuous(labels = scales::percent) +
  labs(x = paste("Percent of Total", 
                 str_remove(string = data_string, pattern = ".*_") %>% 
                   str_replace_all(string = ., pattern = "\\.", replacement = " ") %>%  
                   str_to_title() %>% 
                   str_replace(string = ., pattern = "Rv", replacement = "RV"), 
                 "Reservations"),
       y = "",
       title = paste0("Percentage of Reservations to ", 
                      str_remove(string = data_string, pattern = ".*_") %>% 
                        str_replace_all(string = ., pattern = "\\.", replacement = " ") %>%  
                        str_to_title() %>% 
                        str_replace(string = ., pattern = "Rv", replacement = "RV"),
                      " Sites by <br>Different Racial Groups")) + 
  theme_minimal() +
  theme(plot.background = element_rect("white"),
        panel.grid.major.y = element_blank(),
        legend.position = "none")

ggplotly(plot_race_site_type_remote,
         tooltip = list("text"))
```

```{r}
# RV Only
data <- data_plot_race_site_type_rv.only
data_string <- deparse(substitute(data_plot_race_site_type_rv.only))

plot_race_site_type_rv_only <- ggplot(data = data, 
                                      aes(x = percent_n,
                                          y = reorder(race, percent_n))) +
  geom_segment(aes(xend = 0, yend = reorder(race, percent_n))) +
  geom_point(aes(x = percent_n,
                 y = reorder(race, percent_n),
                 color = race, fill = race,
                 text = paste0("Of visits to ", aggregated_site_type, " sites, ", scales::comma(round(percent_n, 4)*100, accuracy = 1),
                              "% reservations were made by <br>people who live in ZIP codes with high ", 
                              str_to_title(race) %>% str_replace(string = ., pattern = "\\(S\\)", "\\(s\\)"), " populations.")),
             width = .25,
             size = 4, shape = 21, stroke = 2) +
  scale_fill_manual(values = racial_group_colors) +
  scale_color_manual(values = racial_group_colors) +
  scale_x_continuous(labels = scales::percent) +
  labs(x = paste("Percent of Total", 
                 str_remove(string = data_string, pattern = ".*_") %>% 
                   str_replace_all(string = ., pattern = "\\.", replacement = " ") %>%  
                   str_to_title() %>% 
                   str_replace(string = ., pattern = "Rv", replacement = "RV"), 
                 "Reservations"),
       y = "",
       title = paste0("Percentage of Reservations to ", 
                      str_remove(string = data_string, pattern = ".*_") %>% 
                        str_replace_all(string = ., pattern = "\\.", replacement = " ") %>%  
                        str_to_title() %>% 
                        str_replace(string = ., pattern = "Rv", replacement = "RV"),
                      " Sites by <br>Different Racial Groups")) + 
  theme_minimal() +
  theme(plot.background = element_rect("white"),
        panel.grid.major.y = element_blank(),
        legend.position = "none")

ggplotly(plot_race_site_type_rv_only,
         tooltip = list("text"))
```

```{r}
# RV or Tent
data <- data_plot_race_site_type_rv.or.tent
data_string <- deparse(substitute(data_plot_race_site_type_rv.or.tent))

plot_race_site_type_rv_or_tent <- ggplot(data = data, 
                                      aes(x = percent_n,
                                          y = reorder(race, percent_n))) +
  geom_segment(aes(xend = 0, yend = reorder(race, percent_n))) +
  geom_point(aes(x = percent_n,
                 y = reorder(race, percent_n),
                 color = race, fill = race,
                 text = paste0("Of visits to ", aggregated_site_type, " sites, ", scales::comma(round(percent_n, 4)*100, accuracy = 1),
                              "% reservations were made by <br>people who live in ZIP codes with high ", 
                              str_to_title(race) %>% str_replace(string = ., pattern = "\\(S\\)", "\\(s\\)"), " populations.")),
             width = .25,
             size = 4, shape = 21, stroke = 2) +
  scale_fill_manual(values = racial_group_colors) +
  scale_color_manual(values = racial_group_colors) +
  scale_x_continuous(labels = scales::percent) +
  labs(x = paste("Percent of Total", 
                 str_remove(string = data_string, pattern = ".*_") %>% 
                   str_replace_all(string = ., pattern = "\\.", replacement = " ") %>%  
                   str_to_title() %>% 
                   str_replace(string = ., pattern = "Rv", replacement = "RV"), 
                 "Reservations"),
       y = "",
       title = paste0("Percentage of Reservations to ", 
                      str_remove(string = data_string, pattern = ".*_") %>% 
                        str_replace_all(string = ., pattern = "\\.", replacement = " ") %>%  
                        str_to_title() %>% 
                        str_replace(string = ., pattern = "Rv", replacement = "RV"),
                      " Sites by <br>Different Racial Groups")) + 
  theme_minimal() +
  theme(plot.background = element_rect("white"),
        panel.grid.major.y = element_blank(),
        legend.position = "none")

ggplotly(plot_race_site_type_rv_or_tent,
         tooltip = list("text"))
```

```{r}
# Shelter
data <- data_plot_race_site_type_shelter
data_string <- deparse(substitute(data_plot_race_site_type_shelter))

plot_race_site_type_shelter <- ggplot(data = data, 
                                      aes(x = percent_n,
                                          y = reorder(race, percent_n))) +
  geom_segment(aes(xend = 0, yend = reorder(race, percent_n))) +
  geom_point(aes(x = percent_n,
                 y = reorder(race, percent_n),
                 color = race, fill = race,
                 text = paste0("Of visits to ", aggregated_site_type, " sites, ", scales::comma(round(percent_n, 4)*100, accuracy = 1),
                              "% reservations were made by <br>people who live in ZIP codes with high ", 
                              str_to_title(race) %>% str_replace(string = ., pattern = "\\(S\\)", "\\(s\\)"), " populations.")),
             width = .25,
             size = 4, shape = 21, stroke = 2) +
  scale_fill_manual(values = racial_group_colors) +
  scale_color_manual(values = racial_group_colors) +
  scale_x_continuous(labels = scales::percent) +
  labs(x = paste("Percent of Total", 
                 str_remove(string = data_string, pattern = ".*_") %>% 
                   str_replace_all(string = ., pattern = "\\.", replacement = " ") %>%  
                   str_to_title() %>% 
                   str_replace(string = ., pattern = "Rv", replacement = "RV"), 
                 "Reservations"),
       y = "",
       title = paste0("Percentage of Reservations to ", 
                      str_remove(string = data_string, pattern = ".*_") %>% 
                        str_replace_all(string = ., pattern = "\\.", replacement = " ") %>%  
                        str_to_title() %>% 
                        str_replace(string = ., pattern = "Rv", replacement = "RV"),
                      " Sites by <br>Different Racial Groups")) + 
  theme_minimal() +
  theme(plot.background = element_rect("white"),
        panel.grid.major.y = element_blank(),
        legend.position = "none")

ggplotly(plot_race_site_type_shelter,
         tooltip = list("text"))
```

```{r}
# Tent Only
data <- data_plot_race_site_type_tent.only
data_string <- deparse(substitute(data_plot_race_site_type_tent.only))

plot_race_site_type_tent_only <- ggplot(data = data, 
                                      aes(x = percent_n,
                                          y = reorder(race, percent_n))) +
  geom_segment(aes(xend = 0, yend = reorder(race, percent_n))) +
  geom_point(aes(x = percent_n,
                 y = reorder(race, percent_n),
                 color = race, fill = race,
                 text = paste0("Of visits to ", aggregated_site_type, " sites, ", scales::comma(round(percent_n, 4)*100, accuracy = 1),
                              "% reservations were made by <br>people who live in ZIP codes with high ", 
                              str_to_title(race) %>% str_replace(string = ., pattern = "\\(S\\)", "\\(s\\)"), " populations.")),
             width = .25,
             size = 4, shape = 21, stroke = 2) +
  scale_fill_manual(values = racial_group_colors) +
  scale_color_manual(values = racial_group_colors) +
  scale_x_continuous(labels = scales::percent) +
  labs(x = paste("Percent of Total", 
                 str_remove(string = data_string, pattern = ".*_") %>% 
                   str_replace_all(string = ., pattern = "\\.", replacement = " ") %>%  
                   str_to_title() %>% 
                   str_replace(string = ., pattern = "Rv", replacement = "RV"), 
                 "Reservations"),
       y = "",
       title = paste0("Percentage of Reservations to ", 
                      str_remove(string = data_string, pattern = ".*_") %>% 
                        str_replace_all(string = ., pattern = "\\.", replacement = " ") %>%  
                        str_to_title() %>% 
                        str_replace(string = ., pattern = "Rv", replacement = "RV"),
                      " Sites by <br>Different Racial Groups")) + 
  theme_minimal() +
  theme(plot.background = element_rect("white"),
        panel.grid.major.y = element_blank(),
        legend.position = "none")

ggplotly(plot_race_site_type_tent_only,
         tooltip = list("text"))
```

```{r}
### trying out bar instead of lollipop ###

# Water
data <- data_plot_race_site_type_water
data_string <- deparse(substitute(data_plot_race_site_type_water))

plot_race_site_type_water <- ggplot(data = data, 
                                      aes(x = percent_n,
                                          y = reorder(race, percent_n))) +
  # geom_segment(aes(xend = 0, yend = reorder(race, percent_n))) +
  geom_col(aes(x = percent_n,
                 y = reorder(race, percent_n),
                 #color = race, 
               fill = race,
                 text = paste0("Of visits to ", aggregated_site_type, " sites, ", scales::comma(round(percent_n, 4)*100, accuracy = 1),
                              "% reservations were made by <br>people who live in ZIP codes with high ", 
                              str_to_title(race) %>% str_replace(string = ., pattern = "\\(S\\)", "\\(s\\)"), " populations.")),
             # width = .25,
             # size = 4, shape = 21, stroke = 2
           ) +
  scale_fill_manual(values = racial_group_colors) +
  scale_color_manual(values = racial_group_colors) +
  scale_x_continuous(labels = scales::percent) +
  labs(x = paste("Percent of Total", 
                 str_remove(string = data_string, pattern = ".*_") %>% 
                   str_replace_all(string = ., pattern = "\\.", replacement = " ") %>%  
                   str_to_title() %>% 
                   str_replace(string = ., pattern = "Rv", replacement = "RV"), 
                 "Reservations"),
       y = "",
       title = paste0("Percentage of Reservations to ", 
                      str_remove(string = data_string, pattern = ".*_") %>% 
                        str_replace_all(string = ., pattern = "\\.", replacement = " ") %>%  
                        str_to_title() %>% 
                        str_replace(string = ., pattern = "Rv", replacement = "RV"),
                      " Sites by <br>Different Racial Groups")) + 
  theme_minimal() +
  theme(plot.background = element_rect("white"),
        panel.grid.major.y = element_blank(),
        legend.position = "none")

ggplotly(plot_race_site_type_water,
         tooltip = list("text"))
```



### Race x booking window 

```{r}
## -- data wrangle -- ##
racial_groups <- c("other", "pacific_islander", "multiracial", "asian", 
                   "black", "white", "native_american", "hispanic_latinx")

data_plot_race_booking_window <- data.frame()

# create plot df for each group for RIDB data
for (i in seq_along(racial_groups)){
  df_ca_bin_breaks <- data_ca_acs_2018 %>% 
    select(zip_code, asian, black, hispanic_latinx, multiracial, 
           native_american, other, pacific_islander, white, mean_zip_code_population) %>% 
    pivot_longer(cols = 2:9,
                 names_to = "race",
                 values_to = "race_percentage") %>% 
    filter(race == racial_groups[[i]]) %>% ## BACK TO i
    drop_na(race_percentage) 
  
  weighted_half <- weighted.mean(x = df_ca_bin_breaks$race_percentage, w = df_ca_bin_breaks$mean_zip_code_population)
  
  df_ca_bin_breaks <- df_ca_bin_breaks %>% filter(race_percentage >= weighted_half)
  
  weighted_quartile <- weighted.mean(x = df_ca_bin_breaks$race_percentage, w = df_ca_bin_breaks$mean_zip_code_population)
  
  df_racial_group_i_longer <- data_ridb_acs_2018 %>% 
    select(agency, admin_unit, park, customer_zip, asian, black, hispanic_latinx, 
           multiracial, native_american, other, pacific_islander, white,
           booking_window) %>% 
    drop_na(booking_window) %>% 
  pivot_longer(cols = 5:12,
               names_to = "race",
               values_to = "race_percentage") %>% 
    filter(race == racial_groups[[i]]) %>% ## BACK TO i
    drop_na(race_percentage)
  
  max_racial_group_ridb <- df_racial_group_i_longer %>%
    summarize(max = max(race_percentage))
  
  df_racial_i_group <- df_racial_group_i_longer %>% 
    filter(race_percentage >= weighted_quartile) %>% 
    summarize(mean_booking_window = mean(booking_window)) %>% 
    mutate(race = paste0(racial_groups[[i]])) %>%  ## BACK TO i
    relocate(race, .before = 1) %>% 
    mutate(race = str_replace(string = race,
                              pattern = "_",
                              replacement = " "),
           race = str_to_title(race),
           race = str_replace(string = race,
                              pattern = "Other",
                              replacement = "Other Race(s)"))

  data_plot_race_booking_window <- rbind(data_plot_race_booking_window, df_racial_i_group)
    
assign(paste0("top_quartile_ca_", racial_groups[[i]]), 
       c(weighted_quartile), 
       envir = .GlobalEnv)
assign(paste0("max_race_ridb_", racial_groups[[i]]), 
       data.frame(max_racial_group_ridb), 
       envir = .GlobalEnv)
}


## -- create plot -- ##
racial_group_colors <- c("Other Race(s)" = "#999999", "Pacific Islander" = "#E69F00", "Multiracial" = "#56B4E9",
                              "Asian" = "#009E73", "Black" = "#F0E442", "White" = "#0072B2", 
                              "Native American" = "#D55E00", "Hispanic Latinx" = "#CC79A7")


# plot for shiny
plot_race_booking_window <- ggplot(data = data_plot_race_booking_window, 
                                      aes(x = mean_booking_window,
                                          y = reorder(race, mean_booking_window))) +
  geom_segment(aes(xend = 0, yend = race)) +
  geom_point(aes(x = mean_booking_window,
                 y = reorder(race, mean_booking_window),
                 color = race, fill = race,
                 text = paste("People who live in ZIP codes with high", 
                              str_to_title(race) %>% str_replace(string = ., pattern = "\\(S\\)", "\\(s\\)"), 
                              "populations",
                             "<br>make their reservations", round(mean_booking_window, 0), "days before their trip.")),
             width = .25,
             size = 4, shape = 21, stroke = 2) +
  scale_fill_manual(values = racial_group_colors) +
  scale_color_manual(values = racial_group_colors) +
  labs(x = paste("Average Number of Days from Order Date to Reservation Date"),
       y = "",
       title = "Average Number of Days in Advance <br>Reservation is Booked for Different Racial Groups") + 
  theme_minimal() +
  theme(plot.background = element_rect("white"),
        panel.grid.major.y = element_blank(),
        legend.position = "none")

ggplotly(plot_race_booking_window,
         tooltip = list("text"))
```


### Race x daily cost 
```{r}
### need to update data to not be daily cost / visitor / day (but instead cost / day)

## -- data wrangle -- ##
racial_groups <- c("other", "pacific_islander", "multiracial", "asian", 
                   "black", "white", "native_american", "hispanic_latinx")

data_plot_race_daily_cost_per_visitor <- data.frame()

# create plot df for each group for RIDB data
for (i in seq_along(racial_groups)){
  df_ca_bin_breaks <- data_ca_acs_2018 %>% 
    select(zip_code, asian, black, hispanic_latinx, multiracial, 
           native_american, other, pacific_islander, white, mean_zip_code_population) %>% 
    pivot_longer(cols = 2:9,
                 names_to = "race",
                 values_to = "race_percentage") %>% 
    filter(race == racial_groups[[i]]) %>% ## BACK TO i
    drop_na(race_percentage) 
  
  weighted_half <- weighted.mean(x = df_ca_bin_breaks$race_percentage, w = df_ca_bin_breaks$mean_zip_code_population)
  
  df_ca_bin_breaks <- df_ca_bin_breaks %>% filter(race_percentage >= weighted_half)
  
  weighted_quartile <- weighted.mean(x = df_ca_bin_breaks$race_percentage, w = df_ca_bin_breaks$mean_zip_code_population)
  
  df_racial_group_i_longer <- data_ridb_acs_2018 %>% 
    select(agency, admin_unit, park, customer_zip, asian, black, hispanic_latinx, 
           multiracial, native_american, other, pacific_islander, white,
           daily_cost_per_visitor) %>% 
    drop_na(daily_cost_per_visitor) %>% 
    filter(daily_cost_per_visitor != Inf) %>% 
  pivot_longer(cols = 5:12,
               names_to = "race",
               values_to = "race_percentage") %>% 
    filter(race == racial_groups[[i]]) %>% ## BACK TO i
    drop_na(race_percentage)
  
  max_racial_group_ridb <- df_racial_group_i_longer %>%
    summarize(max = max(race_percentage))
  
  df_racial_i_group <- df_racial_group_i_longer %>% 
    filter(race_percentage >= weighted_quartile) %>% 
    summarize(mean_daily_cost_per_visitor = mean(daily_cost_per_visitor)) %>% 
    mutate(race = paste0(racial_groups[[i]])) %>%  ## BACK TO i
    relocate(race, .before = 1) %>% 
    mutate(race = str_replace(string = race,
                              pattern = "_",
                              replacement = " "),
           race = str_to_title(race),
           race = str_replace(string = race,
                              pattern = "Other",
                              replacement = "Other Race(s)"))

  data_plot_race_daily_cost_per_visitor <- rbind(data_plot_race_daily_cost_per_visitor, df_racial_i_group)
    
assign(paste0("top_quartile_ca_", racial_groups[[i]]), 
       c(weighted_quartile), 
       envir = .GlobalEnv)
assign(paste0("max_race_ridb_", racial_groups[[i]]), 
       data.frame(max_racial_group_ridb), 
       envir = .GlobalEnv)
}


## -- create plot -- ##
racial_group_colors <- c("Other Race(s)" = "#999999", "Pacific Islander" = "#E69F00", "Multiracial" = "#56B4E9",
                              "Asian" = "#009E73", "Black" = "#F0E442", "White" = "#0072B2", 
                              "Native American" = "#D55E00", "Hispanic Latinx" = "#CC79A7")


# plot for shiny
plot_race_daily_cost_per_visitor <- ggplot(data = data_plot_race_daily_cost_per_visitor, 
                                      aes(x = mean_daily_cost_per_visitor,
                                          y = reorder(race, mean_daily_cost_per_visitor))) +
  geom_segment(aes(xend = 0, yend = race)) +
  geom_point(aes(x = mean_daily_cost_per_visitor,
                 y = reorder(race, mean_daily_cost_per_visitor),
                 color = race, fill = race,
                 text = paste0("People who live in ZIP codes with high ", 
                               str_to_title(race) %>% str_replace(string = ., pattern = "\\(S\\)", "\\(s\\)"), " populations ",
                             "<br>pay an estimate of ", scales::dollar(mean_daily_cost_per_visitor), " per person per day.")),
             width = .25,
             size = 4, shape = 21, stroke = 2) +
  scale_fill_manual(values = racial_group_colors) +
  scale_color_manual(values = racial_group_colors) +
  scale_x_continuous(labels = scales::dollar) +
  labs(x = paste("Average Daily Cost per Visitor"),
       y = "",
       title = "Average Daily Cost per Visitor for <br>Different Racial Groups") + 
  theme_minimal() +
  theme(plot.background = element_rect("white"),
        panel.grid.major.y = element_blank(),
        legend.position = "none")

ggplotly(plot_race_daily_cost_per_visitor,
         tooltip = list("text"))
```


### Race x length of stay 

```{r}
## -- data wrangle -- ##
racial_groups <- c("other", "pacific_islander", "multiracial", "asian", 
                   "black", "white", "native_american", "hispanic_latinx")

data_plot_race_lenth_of_stay <- data.frame()

# create plot df for each group for RIDB data
for (i in seq_along(racial_groups)){
  df_ca_bin_breaks <- data_ca_acs_2018 %>% 
    select(zip_code, asian, black, hispanic_latinx, multiracial, 
           native_american, other, pacific_islander, white, mean_zip_code_population) %>% 
    pivot_longer(cols = 2:9,
                 names_to = "race",
                 values_to = "race_percentage") %>% 
    filter(race == racial_groups[[i]]) %>% ## BACK TO i
    drop_na(race_percentage) 
  
  weighted_half <- weighted.mean(x = df_ca_bin_breaks$race_percentage, w = df_ca_bin_breaks$mean_zip_code_population)
  
  df_ca_bin_breaks <- df_ca_bin_breaks %>% filter(race_percentage >= weighted_half)
  
  weighted_quartile <- weighted.mean(x = df_ca_bin_breaks$race_percentage, w = df_ca_bin_breaks$mean_zip_code_population)
  
  df_racial_group_i_longer <- data_ridb_acs_2018 %>% 
    select(agency, admin_unit, park, customer_zip, asian, black, hispanic_latinx, 
           multiracial, native_american, other, pacific_islander, white,
           length_of_stay) %>% 
    drop_na(length_of_stay) %>% 
    filter(length_of_stay >= 0) %>% 
  pivot_longer(cols = 5:12,
               names_to = "race",
               values_to = "race_percentage") %>% 
    filter(race == racial_groups[[i]]) %>% ## BACK TO i
    drop_na(race_percentage)
  
  max_racial_group_ridb <- df_racial_group_i_longer %>%
    summarize(max = max(race_percentage))
  
  df_racial_i_group <- df_racial_group_i_longer %>% 
    filter(race_percentage >= weighted_quartile) %>% 
    summarize(mean_length_of_stay = mean(length_of_stay)) %>% 
    mutate(race = paste0(racial_groups[[i]])) %>%  ## BACK TO i
    relocate(race, .before = 1) %>% 
    mutate(race = str_replace(string = race,
                              pattern = "_",
                              replacement = " "),
           race = str_to_title(race),
           race = str_replace(string = race,
                              pattern = "Other",
                              replacement = "Other Race(s)"))

  data_plot_race_lenth_of_stay <- rbind(data_plot_race_lenth_of_stay, df_racial_i_group)
    
assign(paste0("top_quartile_ca_", racial_groups[[i]]), 
       c(weighted_quartile), 
       envir = .GlobalEnv)
assign(paste0("max_race_ridb_", racial_groups[[i]]), 
       data.frame(max_racial_group_ridb), 
       envir = .GlobalEnv)
}


## -- create plot -- ##
racial_group_colors <- c("Other Race(s)" = "#999999", "Pacific Islander" = "#E69F00", "Multiracial" = "#56B4E9",
                              "Asian" = "#009E73", "Black" = "#F0E442", "White" = "#0072B2", 
                              "Native American" = "#D55E00", "Hispanic Latinx" = "#CC79A7")


# plot for shiny
plot_race_lenth_of_stay <- ggplot(data = data_plot_race_lenth_of_stay, 
                                      aes(x = mean_length_of_stay,
                                          y = reorder(race, mean_length_of_stay))) +
  geom_segment(aes(xend = 0, yend = race)) +
  geom_point(aes(x = mean_length_of_stay,
                 y = reorder(race, mean_length_of_stay),
                 color = race, fill = race,
                 text = paste0("People who live in ZIP codes with high ", 
                               str_to_title(race) %>% str_replace(string = ., pattern = "\\(S\\)", "\\(s\\)"), " populations ",
                             "<br>stay at overnight reservable sites for an estimated ", round(mean_length_of_stay, 0), " days.")),
             width = .25,
             size = 4, shape = 21, stroke = 2) +
  scale_fill_manual(values = racial_group_colors) +
  scale_color_manual(values = racial_group_colors) +
  labs(x = paste("Average Length of Stay"),
       y = "",
       title = "Average Length of Stay for <br>Different Racial Groups") + 
  theme_minimal() +
  theme(plot.background = element_rect("white"),
        panel.grid.major.y = element_blank(),
        legend.position = "none")

ggplotly(plot_race_lenth_of_stay,
         tooltip = list("text"))
```


### Education x distance traveled 


### Education x site type 


### Education x booking window 


### Education x daily cost 


### Education x length of stay 


### Language 


### Median-income x distance traveled


### Booking window x site type


### Booking window x distance traveled


```{r}
end_time <- Sys.time()
time_taken <- end_time - start_time
time_taken
```

