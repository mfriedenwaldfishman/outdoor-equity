---
title: "Data Viz for Shiny App"
author: "Clarissa"
date: "3/16/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(here)
library(janitor)
library(lubridate)
library(sf)
library(tidycensus)
library(patchwork)
library(scales)
library(tmap)
library(vroom)
library(paletteer)

options(scipen = 999)

# load script to pull and clean ACS data
source("../functions/function_acs_race.R")
source("../functions/function_acs_median_income.R")
source("../functions/function_acs_transportation.R")
source("../functions/function_acs_education.R")
source("../functions/function_acs_language.R")
```

# Read in data

```{r, message=FALSE, warning=FALSE}
# read in joined data
data_ridb_acs_2018 <- vroom(file = "../../../../data_clean/2018_joined_data.csv",
                            delim = ",")
# data_ridb_acs_2018 <- readRDS(file = "../../../../data_clean/2018_joined_data.rds") # don't use RDS for non-map viz

# ACS CA data
acs_subset_calculate_race(geography = "zcta", year = 2018, state = "California")
acs_subset_calculate_education(geography = "zcta", year = 2018, state = "California")
acs_subset_calculate_language(geography = "zcta", state = "California")
acs_subset_calculate_transportation(geography = "zcta", year = 2018, state = "California")
acs_subset_calculate_median_income(geography = "zcta", year = 2018, state = "California")

# ACS US data
# acs_subset_calculate_race(geography = "zcta", year = 2018, state = NULL)
# acs_subset_calculate_education(geography = "zcta", year = 2018, state = NULL)
```


# RIDB data

## Distance traveled (histogram/density)

```{r}
## -- data wrangle -- ##
data_plot_hist_distance_traveled <- data_ridb_acs_2018 %>% 
  mutate(distance_traveled_mi = distance_traveled_m * 0.000621371)

## -- create plot -- ##

# parameters
hist_colors <- c("#009900FF")

# plot for shiny app
plot_hist_distance_traveled <-
  ggplot(data = data_plot_hist_distance_traveled) +
  geom_histogram(aes(x = distance_traveled_mi),
                 fill = hist_colors)+
  labs(x = "Distance traveled (miles)",
       y = "",
       title = "Distribution of Distance Traveled to ",
       subtitle = "Overnight Reservations in California in 2018") +
  scale_x_continuous(limits = c(0, 3000), breaks = seq(0, 3000, 500), minor_breaks = seq(0, 3000, 250)) +
  theme_minimal() +
  theme(plot.background = element_rect("white"),
        panel.grid.major.y = element_blank(),
        # ## only needed for saving as image
        # axis.text = element_text(size = 20),
        # axis.title = element_text(size = 22, face = "bold"),
        # title = element_text(size = 24, face = "bold")
        )

plot_hist_distance_traveled
```


## Booking window (histogram/density)

```{r}
## -- data wrangle -- ##
data_plot_hist_boooking_window <- data_ridb_acs_2018 %>% 
  filter(booking_window > 0)

## -- create plot -- ##

# parameters
hist_colors <- c("#009900FF")

# plot for shiny app
plot_hist_booking_window <-
  ggplot(data = data_plot_hist_boooking_window) +
  geom_histogram(aes(x = booking_window),
                 binwidth = 7,
                 fill = hist_colors) +
  labs(x = "Days elapsed from order to visit (each bar = 1 week)",
       y = "",
       title = "Distribution of Booking Windows for",
       subtitle = "Overnight Reservations in California in 2018") +
  scale_x_continuous(limits = c(0, 510), 
                     breaks = seq(0, 510, by = 30)) +
  geom_vline(xintercept = 180, 
             linetype = "dashed", size = .3, alpha = .5) +
  annotate("text", label = "6 months", 
           x = 210, y = 65000) +
  geom_vline(xintercept = 360, 
             linetype = "dashed", size = .3, alpha = .5) +
  annotate("text", label = "1 year", 
           x = 380, y = 65000) +
  theme_minimal() +
  theme(plot.background = element_rect("white"),
        panel.grid.major.y = element_blank(),
        # ## only needed for saving as image
        # axis.text = element_text(size = 20),
        # axis.title = element_text(size = 22, face = "bold"),
        # title = element_text(size = 24, face = "bold")
        )

plot_hist_booking_window
```


## Daily cost per visitor (histogram/density)

```{r}
## -- data wrangle -- ##
data_plot_hist_daily_cost_per_visitor <- data_ridb_acs_2018 %>% 
  filter(daily_cost_per_visitor != "Inf")

## -- create plot -- ##

# parameters
hist_colors <- c("#009900FF")

# plot for shiny app
plot_hist_daily_cost_per_visitor <-
  ggplot(data = data_plot_hist_daily_cost_per_visitor) +
  geom_histogram(aes(x = daily_cost_per_visitor),
                 fill = hist_colors) +
  labs(x = "Daily cost per visitor ($)",
       y = "",
       title = "Distribution of Daily Costs per Visitor for",
       subtitle = "Overnight Reservations in California in 2018") +
  scale_x_continuous(limits = c(0, 50),
                     breaks = seq(0, 50, by = 10)) +
  theme_minimal() +
  theme(plot.background = element_rect("white"),
        panel.grid.major.y = element_blank(),
        # ## only needed for saving as image
        # axis.text = element_text(size = 20),
        # axis.title = element_text(size = 22, face = "bold"),
        # title = element_text(size = 24, face = "bold")
        )

plot_hist_daily_cost_per_visitor
```


## Length of Stay (histogram/density)

```{r}
## -- data wrangle -- ##
data_plot_hist_length_of_stay <- data_ridb_acs_2018

## -- create plot -- ##

# parameters
hist_colors <- c("#009900FF")

# plot for shiny app
plot_hist_length_of_stay <-
  ggplot(data = data_plot_hist_length_of_stay) +
  geom_histogram(aes(x = length_of_stay),
                 binwidth = 1,
                 fill = hist_colors) +
  labs(x = "Length of stay (days)",
       y = "",
       title = "Distribution of Length of Stay for",
       subtitle = "Overnight Reservations in California in 2018") +
  # scale_x_continuous(limits = c(0, 50),
  #                    breaks = seq(0, 50, by = 10)) +
  theme_minimal() +
  theme(plot.background = element_rect("white"),
        panel.grid.major.y = element_blank(),
        # ## only needed for saving as image
        # axis.text = element_text(size = 20),
        # axis.title = element_text(size = 22, face = "bold"),
        # title = element_text(size = 24, face = "bold")
        )

plot_hist_length_of_stay
```


## Site Type (column)

```{r}
## -- data wrangle -- ##
data_plot_col_site_type <- data_ridb_acs_2018 %>% 
  group_by(aggregated_site_type) %>% 
  summarise(count = n()) %>% 
  mutate(aggregated_site_type = factor(aggregated_site_type, 
                                       levels = c("shelter", "rv only", "rv or tent",
                                                  "tent only", "remote", "equestrian",
                                                  "water")))
data_plot_col_site_type$aggregated_site_type <- with(data_plot_col_site_type, reorder(aggregated_site_type, count))

 
## -- create plot -- ##

# parameters
hist_colors <- c("#009900FF")

# plot for shiny app
plot_hist_site_type <-
  ggplot(data = data_plot_col_site_type) +
  geom_col(aes(x = count,
               y = aggregated_site_type),
                 fill = hist_colors) +
  scale_x_continuous(labels = comma) +
  labs(x = "Number of Sites",
       y = "Types of Sites",
       title = "Distribution of Type of Sites for",
       subtitle = "Overnight Reservations in California in 2018") +
  theme_minimal() +
  theme(plot.background = element_rect("white"),
        panel.grid.major.y = element_blank(),
        # ## only needed for saving as image
        # axis.text = element_text(size = 20),
        # axis.title = element_text(size = 22, face = "bold"),
        # title = element_text(size = 24, face = "bold")
        )

plot_hist_site_type
```




# ACS data

## Race (column)

```{r}
## -- data wrangle -- ##

# reservations in CA
data_plot_col_race_ridb <- data_ridb_acs_2018 %>%
  summarize(white = (mean(white, na.rm = TRUE) * 100),
            black = (mean(black, na.rm = TRUE) * 100),
            asian = (mean(asian, na.rm = TRUE) * 100),
            multiracial = (mean(multiracial, na.rm = TRUE) * 100),
            other = (mean(other, na.rm = TRUE) * 100),
            native_american = (mean(native_american, na.rm = TRUE) * 100),
            pacific_islander = (mean(pacific_islander, na.rm = TRUE) * 100),
            hispanic_latinx = (mean(hispanic_latinx, na.rm = TRUE) * 100)) %>%
  pivot_longer(cols = 1:8, names_to = "race", values_to = "race_percent_average") %>% 
  mutate(race = str_replace(string = race,
                            pattern = "_",
                            replacement = " "),
         race = str_to_title(race))
data_plot_col_race_ridb$race <- with(data_plot_col_race_ridb, reorder(race, race_percent_average))

# CA population
data_plot_col_race_ca <- data_acs_2018_race_percent_California %>%
  summarize(white = (mean(white, na.rm = TRUE) * 100),
            black = (mean(black, na.rm = TRUE) * 100),
            asian = (mean(asian, na.rm = TRUE) * 100),
            multiracial = (mean(multiracial, na.rm = TRUE) * 100),
            other = (mean(other, na.rm = TRUE) * 100),
            native_american = (mean(native_american, na.rm = TRUE) * 100),
            pacific_islander = (mean(pacific_islander, na.rm = TRUE) * 100),
            hispanic_latinx = (mean(hispanic_latinx, na.rm = TRUE) * 100)) %>%
  pivot_longer(cols = 1:8, names_to = "race", values_to = "race_percent_average") %>% 
  mutate(race = str_replace(string = race,
                            pattern = "_",
                            replacement = " "),
         race = str_to_title(race))
data_plot_col_race_ca$race <- with(data_plot_col_race_ca, reorder(race, race_percent_average))

# join data for plotting
data_plot_col_race <- data_plot_col_race_ridb %>% 
  left_join(y = data_plot_col_race_ca,
            by = c("race"),
            suffix = c("_ridb", "_ca")) %>% 
  rename(RIDB = race_percent_average_ridb,
         CA = race_percent_average_ca) %>% 
  pivot_longer(cols = 2:3,
               names_to = "data_source",
               values_to = "race_percent_average") %>% 
  mutate(data_source = factor(data_source, levels = c("RIDB", "CA")))

## -- create plot -- ##

# parameters
groups_colors_ridb_ca <- c("RIDB" = "#009900FF", "CA" = "#666666")

# plot for shiny app
plot_col_race <- 
  ggplot(data = data_plot_col_race) +
  geom_col(aes(x = race_percent_average,
               y = race,
               fill = data_source),
           stat = "identity",
           position = "dodge") +
  scale_fill_manual(values = groups_colors_ridb_ca) +  
  geom_text(aes(x = race_percent_average,
                y = race,
                label = paste0(round(race_percent_average, 1), "%"),
                col = data_source), 
            position = position_dodge(width = 1), 
            hjust = -0.1, size = 4) +
  scale_color_manual(values = groups_colors_ridb_ca) +
  labs(x = "Percentage (%)",
       y = "",
       title = "Racial Breakdown of ZIP Codes in 2018",
       subtitle = "Visitors' home ZIP codes for Overnight Reservations in California \nvs. California Residents") +
  scale_x_continuous(limits = c(0, 60), breaks = seq(0, 60, 10), minor_breaks = seq(0, 60, 5)) +
  theme_minimal() +
  theme(plot.background = element_rect("white"),
        panel.grid.major.y = element_blank(),
        # ## only needed for saving as image
        # axis.text = element_text(size = 20),
        # axis.title = element_text(size = 22, face = "bold"),
        # title = element_text(size = 24, face = "bold")
        )

plot_col_race
```

## Education (column)

```{r}
## -- data wrangle -- ##

# reservations in CA
data_plot_col_education_ridb <- data_ridb_acs_2018 %>%
  summarize(hs_GED_or_below = (mean(hs_GED_or_below, na.rm = TRUE) * 100),
            some_college = (mean(some_college, na.rm = TRUE) * 100),
            college = (mean(college, na.rm = TRUE) * 100),
            master_or_above = (mean(master_or_above, na.rm = TRUE) * 100))  %>%
  pivot_longer(cols = 1:4, names_to = "education", values_to = "education_percent_average") %>% 
  mutate(education = str_replace(string = education,
                            pattern = "hs_GED_or_below",
                            replacement = "High school, GED, or below"),
         education = str_replace(string = education,
                            pattern = "some_college",
                            replacement = "Some College"),
         education = str_replace(string = education,
                            pattern = "college",
                            replacement = "Associates or bachelors degree"),
         education = str_replace(string = education,
                            pattern = "master_or_above",
                            replacement = "Masters degree or higher"))

# CA population
data_plot_col_education_ca <- data_acs_2018_education_percent_California %>%
  summarize(hs_GED_or_below = (mean(hs_GED_or_below, na.rm = TRUE) * 100),
            some_college = (mean(some_college, na.rm = TRUE) * 100),
            college = (mean(college, na.rm = TRUE) * 100),
            master_or_above = (mean(master_or_above, na.rm = TRUE) * 100))  %>%
  pivot_longer(cols = 1:4, names_to = "education", values_to = "education_percent_average") %>% 
  mutate(education = str_replace(string = education,
                            pattern = "hs_GED_or_below",
                            replacement = "High school, GED, or below"),
         education = str_replace(string = education,
                            pattern = "some_college",
                            replacement = "Some College"),
         education = str_replace(string = education,
                            pattern = "college",
                            replacement = "Associates or bachelors degree"),
         education = str_replace(string = education,
                            pattern = "master_or_above",
                            replacement = "Masters degree or higher"))

# join data for plotting
data_plot_col_education <- data_plot_col_education_ridb %>% 
  left_join(y = data_plot_col_education_ca,
            by = c("education"),
            suffix = c("_ridb", "_ca")) %>% 
  rename(RIDB = education_percent_average_ridb,
         CA = education_percent_average_ca) %>% 
  pivot_longer(cols = 2:3,
               names_to = "data_source",
               values_to = "education_percent_average") %>% 
  mutate(data_source = factor(data_source, levels = c("RIDB", "CA")),
         education = factor(education, levels = c("High school, GED, or below",
                                                  "Some College", 
                                                  "Associates or bachelors degree",
                                                  "Masters degree or higher")))

## -- create plot -- ##

# parameters
groups_colors_ridb_ca <- c("RIDB" = "#009900FF", "CA" = "#666666")

# plot for shiny app
plot_col_education <- 
  ggplot(data = data_plot_col_education) +
  geom_col(aes(x = education_percent_average,
               y = education,
               fill = data_source),
           stat = "identity",
           position = "dodge") +
  scale_fill_manual(values = groups_colors_ridb_ca) +  
  geom_text(aes(x = education_percent_average,
                y = education,
                label = paste0(round(education_percent_average, 1), "%"),
                col = data_source), 
            position = position_dodge(width = 1), 
            hjust = -0.1, size = 4) +
  scale_color_manual(values = groups_colors_ridb_ca) +
  labs(x = "Percentage (%)",
       y = "",
       title = "Breakdown of Education Levels of ZIP Codes in 2018",
       subtitle = "Visitors' home ZIP codes for Overnight Reservations in California \nvs. California Residents") +
  scale_x_continuous(limits = c(0, 60), breaks = seq(0, 60, 10), minor_breaks = seq(0, 60, 5)) +
  theme_minimal() +
  theme(plot.background = element_rect("white"),
        panel.grid.major.y = element_blank(),
        # ## only needed for saving as image
        # axis.text = element_text(size = 20),
        # axis.title = element_text(size = 22, face = "bold"),
        # title = element_text(size = 24, face = "bold")
        )

plot_col_education
```


## Language (histogram/density)

```{r}
## -- data wrangle -- ##

# reservations in CA
data_plot_density_language_ridb <- data_ridb_acs_2018 %>%
  select(agency, regional_area, park, customer_zip, not_english_only) %>% 
  mutate(not_english_only = not_english_only * 100)

# CA population
data_plot_density_language_ca <- data_acs_2020_language_percent_California %>%
  select(zip_code, not_english_only) %>% 
  mutate(not_english_only = not_english_only * 100)


## -- create plot -- ##

# parameters
groups_colors_ridb_ca <- c("RIDB" = "#009900FF", "CA" = "#666666")

# plot for shiny app
plot_density_language <- ggplot() +
  geom_histogram(data = data_plot_density_language_ca,
                 aes(x = not_english_only,
                     y = stat(count) / sum(count),
                     bins = 10),
                 fill = groups_colors_ridb_ca[[2]],
                 alpha = 0.75) +
  geom_histogram(data = data_plot_density_language_ridb,
                 aes(x = not_english_only,
                     y = stat(count) / sum(count),
                     bins = 10),
                 fill = groups_colors_ridb_ca[[1]],
                 alpha = 0.75) +
  labs(x = "Percentage (%)",
       y = "",
       title = "Distribution of Non-English Spoken in the Home in ZIP Codes in 2018",
       subtitle = "Visitors' home ZIP codes for Overnight Reservations in California \nvs. California Residents") +
  scale_x_continuous(limits = c(0, 100), breaks = seq(0, 100, 10), minor_breaks = seq(0, 100, 5)) +
  scale_y_continuous(labels = scales::percent) +
  theme_minimal() +
  theme(plot.background = element_rect("white"),
        panel.grid.major.y = element_blank()
        # ## only needed for saving as image
        # axis.text = element_text(size = 20),
        # axis.title = element_text(size = 22, face = "bold"),
        # title = element_text(size = 24, face = "bold")
        )

plot_density_language
```


## Transportation (histogram/density)

```{r}
## -- data wrangle -- ##

# reservations in CA
data_plot_density_transportation_ridb <- data_ridb_acs_2018 %>%
  select(agency, regional_area, park, customer_zip, no_vehicle) %>% 
  mutate(no_vehicle = no_vehicle * 100)

# CA population
data_plot_density_transportation_ca <- data_acs_2018_transportation_percent_California %>%
  select(zip_code, no_vehicle) %>% 
  mutate(no_vehicle = no_vehicle * 100)


## -- create plot -- ##

# parameters
groups_colors_ridb_ca <- c("RIDB" = "#009900FF", "CA" = "#666666")

# plot for shiny app
plot_density_transportation <- ggplot() +
  geom_histogram(data = data_plot_density_transportation_ca,
                 aes(x = no_vehicle,
                     y = stat(count) / sum(count),
                     bins = 100),
                 fill = groups_colors_ridb_ca[[2]],
                 alpha = 0.75) +
  geom_histogram(data = data_plot_density_transportation_ridb,
                 aes(x = no_vehicle,
                     y = stat(count) / sum(count),
                     bins = 100), 
                 fill = groups_colors_ridb_ca[[1]],
                 alpha = 0.75) +
  labs(x = "Percentage (%)",
       y = "",
       title = "Distribution of No Personal Vehicle Available in Home in ZIP Codes in 2018",
       subtitle = "Visitors' home ZIP codes for Overnight Reservations in California \nvs. California Residents") +
  scale_x_continuous(limits = c(0, 20), breaks = seq(0, 20, 1), minor_breaks = seq(0, 20, .5)) +
  scale_y_continuous(labels = scales::percent) +
  theme_minimal() +
  theme(plot.background = element_rect("white"),
        panel.grid.major.y = element_blank()
        # ## only needed for saving as image
        # axis.text = element_text(size = 20),
        # axis.title = element_text(size = 22, face = "bold"),
        # title = element_text(size = 24, face = "bold")
        )

plot_density_transportation
```


## Median income (histogram/density)

```{r}
## -- data wrangle -- ##

# reservations in CA
data_plot_density_median_income_ridb <- data_ridb_acs_2018 %>%
  select(agency, regional_area, park, customer_zip, median_income)

# CA population
data_plot_density_median_income_ca <- data_acs_2018_median_income_California %>%
  select(zip_code, median_income)


## -- create plot -- ##

# parameters
groups_colors_ridb_ca <- c("RIDB" = "#009900FF", "CA" = "#666666")

# plot for shiny app
plot_density_median_income <- ggplot() +
  geom_histogram(data = data_plot_density_median_income_ca,
                 aes(x = median_income,
                     y = stat(count) / sum(count),
                     bins = 10),
                 fill = groups_colors_ridb_ca[[2]], 
                 alpha = 0.75) +
  geom_histogram(data = data_plot_density_median_income_ridb,
                 aes(x = median_income,
                     y = stat(count) / sum(count),
                     bins = 10), 
                 fill = groups_colors_ridb_ca[[1]], 
                 alpha = 0.75) +
  geom_vline(xintercept = 75277, 
             linetype = "dashed", size = .3, alpha = .5) +
  annotate("text", label = "Median household income \nin 2018 in CA ($75,277)", 
           x = 118000, y = .15) +
  labs(x = "Median Income ($))",
       y = "",
       title = "Distribution of Median Income in Home in ZIP Codes in 2018",
       subtitle = "Visitors' home ZIP codes for Overnight Reservations in California \nvs. California Residents") +
  scale_x_continuous(limits = c(0, 260000), breaks = seq(0, 260000, 50000), minor_breaks = seq(0, 260000, 25000), labels = comma) +
  scale_y_continuous(labels = scales::percent) +
  theme_minimal() +
  theme(plot.background = element_rect("white"),
        panel.grid.major.y = element_blank()
        # ## only needed for saving as image
        # axis.text = element_text(size = 20),
        # axis.title = element_text(size = 22, face = "bold"),
        # title = element_text(size = 24, face = "bold")
        )

plot_density_median_income
```

## Save plot all data to RDS
```{r}
plot_data <- c("data_plot_hist_distance_traveled", "data_plot_hist_boooking_window", 
               "data_plot_hist_daily_cost_per_visitor", "data_plot_hist_length_of_stay", 
               "data_plot_col_site_type", "data_plot_col_race", "data_plot_col_education")

for (i in seq_along(plot_data)){
  saveRDS(object = get(plot_data[[i]]),
          file = paste0("../../../../data_clean/2018_data_graphs_single_variable/2018_", 
                        plot_data[[i]],
                        ".rds"))
}
```



