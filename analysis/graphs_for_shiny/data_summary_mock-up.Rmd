---
title: "Variables - 2nd try"
author: "Clarissa"
date: "4/10/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(tidyverse)
library(here)
library(janitor)
library(lubridate)
library(tidycensus)
library(patchwork)
library(scales)
library(vroom)
library(paletteer)
library(plotly)

options(scipen = 999)

# load script to pull and clean ACS data
source("../functions/function_acs_race.R")
source("../functions/function_acs_median_income.R")
source("../functions/function_acs_education.R")
source("../functions/function_acs_language.R")
```


```{r load data}
# read in joined data
data_ridb_acs_2018 <- vroom(file = "../../../../data_clean/2018_joined_data.csv",
                            delim = ",")
# data_ridb_acs_2018 <- readRDS(file = "../../../../data_clean/2018_joined_data.rds") # don't use RDS for non-map viz

# ACS CA data
acs_subset_calculate_race(geography = "zcta", year = 2018, state = "California")
acs_subset_calculate_education(geography = "zcta", year = 2018, state = "California")
acs_subset_calculate_language(geography = "zcta", state = "California")
acs_subset_calculate_median_income(geography = "zcta", year = 2018, state = "California")
data_acs_2018_median_income_California <- data_acs_2018_median_income_California %>% 
  left_join(y = data_acs_2018_education_percent_California,
            by = "zip_code") %>% 
  select(zip_code, median_income, zip_code_population)
```


## Agency Analysis: Distribution Graphs

### Distance traveled

```{r}
## -- data wrangle -- ##
data_plot_distance_traveled_all <- data_ridb_acs_2018 %>% 
  filter(park == "Holiday Group Campground") %>% 
  mutate(distance_traveled_mi = distance_traveled_m * 0.000621371) %>% 
  select(agency, admin_unit, park, distance_traveled_mi) %>% 
  filter(!is.na(distance_traveled_mi))

quant_80 <- quantile(x = data_plot_distance_traveled_all$distance_traveled_mi,
                     probs = seq(0, 1, 0.1))[[9]] %>% round(0)

data_plot_distance_traveled_under80th_quant <- data_ridb_acs_2018 %>% 
  filter(park == "Holiday Group Campground") %>%  
  mutate(distance_traveled_mi = distance_traveled_m * 0.000621371) %>% 
  select(agency, admin_unit, park, distance_traveled_mi) %>% 
  filter(distance_traveled_mi < quant_80 & distance_traveled_mi > 0)

split_all <- data.frame(table(cut(x = data_plot_distance_traveled_all$distance_traveled_mi, 
                                       breaks = seq(0, 
                                                    round(max(data_plot_distance_traveled_all$distance_traveled_mi), 0),
                                                    round(max(data_plot_distance_traveled_all$distance_traveled_mi), 0) / 100))))
split_under_80th <- data.frame(table(cut(x = data_plot_distance_traveled_under80th_quant$distance_traveled_mi, 
                                         breaks = seq(0, 
                                                      quant_80, 
                                                      10))))

## -- create plot -- ##

# parameters
hist_colors <- c("#009900FF", "#00c000")

# plot_1 for shiny app
center_bin <- round((max(data_plot_distance_traveled_all$distance_traveled_mi) / 100) / 5) * 5
x_limits <- c(0, round(max(data_plot_distance_traveled_all$distance_traveled_mi) / 5) * 5)
x_breaks <- seq(0, round(max(data_plot_distance_traveled_all$distance_traveled_mi) / 5) * 5, 
                center_bin * 10)

plot_distance_traveled_1 <-
  ggplot(data = data_plot_distance_traveled_all) +
  geom_histogram(aes(x = distance_traveled_mi,
                     text = paste0(scales::comma(round(..count.. / nrow(data_plot_distance_traveled_all), 2) * 100), 
                                   "% of all reservations traveled between ", xmin, " and ", xmax, " miles",
                                   "<br>Number of Reservations: ", scales::comma(..count..))),
                 binwidth = center_bin * 2,
                 center = center_bin,
                 fill = hist_colors[[1]], 
                 col = hist_colors[[2]], size = 0.05) +
  scale_y_continuous(labels = scales::comma) +
  scale_x_continuous(limits = x_limits#, 
                     #breaks = x_breaks
                     ) +
  labs(x = "Distance traveled (miles)",
       y = "",
       title = "Distance Traveled from Home to Site for <br>Overnight Reservations in California in 2018") +
  annotate("text", 
           x = round(max(data_plot_distance_traveled_all$distance_traveled_mi) / 2, 0), 
           y = (max(split_all$Freq) - min(split_all$Freq)) / 2,
           label = paste0("80% of reservations to \nCalifornia overnight sites in ",
                          deparse(substitute(data_ridb_acs_2018)) %>% str_remove(".*_"),
                          "\n traveled less than ", quant_80, " miles.")) +
  theme_minimal() +
  theme(plot.background = element_rect("white"),
        panel.grid.major.y = element_blank())


# plot_2 for shiny app
center_bin <- round((max(data_plot_distance_traveled_under80th_quant$distance_traveled_mi) / 10) / 5) * 5
x_max <- round(max(data_plot_distance_traveled_under80th_quant$distance_traveled_mi) / 5) * 5
x_limits <- c(0, x_max)
x_breaks <- c(0, x_max, (center_bin))

plot_distance_traveled_2 <- 
  ggplot(data_plot_distance_traveled_under80th_quant) +
  geom_histogram(aes(x = distance_traveled_mi,
                     text = paste0(scales::comma(round(..count.. / nrow(data_plot_distance_traveled_all), 2) * 100), 
                                   "% of all reservations traveled between ", xmin, " and ", xmax, " miles",
                                   "<br>Number of Reservations: ", scales::comma(..count..))),
                 binwidth = center_bin * 2,
                 center = center_bin,
                 fill = hist_colors,
                 #fill = replace(rep(hist_colors[[1]], nrow(split_under_80th)), which.max(split_under_80th$Freq), hist_colors[[2]]), 
                 col = hist_colors[[2]], size = 0.05) +
  scale_y_continuous(labels = scales::comma) +
  scale_x_continuous(limits = x_limits#,
                     #breaks = x_breaks
                     ) +
  labs(x = "Distance traveled (miles)",
       y = "",
       title = "Distance Traveled from Home to Site for <br>Overnight Reservations in California in 2018") +
  theme_minimal() +
  theme(plot.background = element_rect("white"),
        panel.grid.major.y = element_blank())
```



```{r}
ggplotly(plot_distance_traveled_1,
         tooltip = list("text"))
```


```{r}
ggplotly(plot_distance_traveled_2,
         tooltip = list("text"))
```

```{r, eval=FALSE}
data_400to500 <- data_plot_distance_traveled_under500 %>% 
         filter(distance_traveled_mi > 400 & distance_traveled_mi < 500)
perc_400to500 <- nrow(data_400to500) / nrow(data_plot_distance_traveled_all)

data_300to400 <- data_plot_distance_traveled_under500 %>% 
         filter(distance_traveled_mi > 300 & distance_traveled_mi < 400)
perc_300to400 <- 
  nrow(data_300to400) / nrow(data_plot_distance_traveled_all)

data_200to300 <- data_plot_distance_traveled_under500 %>% 
         filter(distance_traveled_mi > 200 & distance_traveled_mi < 300)
perc_200to300 <- 
  nrow(data_200to300) / nrow(data_plot_distance_traveled_all)

data_100to200 <- data_plot_distance_traveled_under500 %>% 
         filter(distance_traveled_mi > 100 & distance_traveled_mi < 200)
perc_100to200 <- 
  nrow(data_100to200) / nrow(data_plot_distance_traveled_all)

data_50to100 <- data_plot_distance_traveled_under500 %>% 
         filter(distance_traveled_mi > 50 & distance_traveled_mi < 100)
perc_50to100 <- 
  nrow(data_50to100) / nrow(data_plot_distance_traveled_all)

data_under50 <- data_plot_distance_traveled_under500 %>% 
         filter(distance_traveled_mi < 50)
perc_under50 <- 
  nrow(data_under50) / nrow(data_plot_distance_traveled_all)

data_list <- c("perc_400to500", "perc_300to400", "perc_200to300", 
               "perc_100to200", "perc_50to100")
sentence_list <- list()

for (i in seq_along(data_list)){
  object_name <- get(paste0(data_list[[i]]))
  
  output <- paste0(
    round(object_name, 2) * 100,
    "% of reservations to California overnight sites in ",
    deparse(substitute(data_ridb_acs_2018)) %>% str_remove(".*_"),
    " traveled between ",
    data_list[[i]] %>% str_remove(".*_") %>% str_remove("[:alpha:]{2}[:digit:]{3}$"),
    " and ",
    data_list[[i]] %>% str_remove(".*_") %>% str_remove(".*o"),
    " miles.")
  
  sentence_list <- rbind(sentence_list, output)
}
```








