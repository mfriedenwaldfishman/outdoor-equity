---
title: "Data Cleaning"
author: "Clarissa Boyajian and Halina Do-Linh"
date: "1/24/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(here)
library(janitor)
library(lubridate)
library(vroom)
library(sf)
library(tidycensus)

options(scipen = 999)

# RIDB functions
# data subset
source("functions/function_ridb_subset-pre2018.R")
source("functions/function_ridb_subset-post2019.R")
# clean data and calculate variables
source("functions/function_ridb_variable_calculate-pre2018.R")

# ACS functions
source("functions/function_acs_race.R")
source("functions/function_acs_median_income.R")
source("functions/function_acs_transportation.R")
source("functions/function_acs_education.R")
source("functions/function_acs_language.R")

# join RIDB and ACS function
source("functions/function_join_ridb_acs.R")

# summarized joined data to park level
source("functions/function_joined_data_park_summary.R")
```

# RIDB - read in data, calculate varibales, standardize values

```{r}
## 2018
# read in data subset for specific year and state 
RIDB_subset_pre2018(full_file_path = "../../data_raw/reservations2018.csv", 
                    state_abbrev = "CA", year = 2018)
# clean and calculate variables
RIDB_calculate_pre2018(input_df_name = data_ridb_2018, output_df_name = "data_ridb_2018")
```


# Census Data - api set up, read, subset, calculate values

```{r, message=FALSE}
# api set up

# # ONLY HAVE TO RUN THE FIRST TIME USING THIS RMD on a new machine
# census_api <- source("private/census-api.R")
# census_api_key(key = census_api[[1]], install = TRUE, overwrite = TRUE)
# # run in console:
## readRenviron("~/.Renviron")

# look at option variables
#View(load_variables(2018, "acs5", cache = TRUE))
```

```{r}
# read in, subset, and clean census data
acs_subset_calculate_race(geography = "zcta", year = 2018, state = NULL)
acs_subset_calculate_median_income(geography = "zcta", year = 2018, state = NULL)
acs_subset_calculate_transportation(geography = "zcta", year = 2018, state = NULL)
acs_subset_calculate_education(geography = "zcta", year = 2018, state = NULL)
acs_subset_calculate_language(geography = "zcta", state = NULL)
```


# Join RIDB and Census

```{r}
join_ridb_acs_data(ridb_df = data_ridb_2018,
                   acs_df_race = data_acs_2018_race_percent,
                   acs_df_education = data_acs_2018_education_percent,
                   acs_df_median_income = data_acs_2018_median_income,
                   acs_df_transportation = data_acs_2018_transportation_percent,
                   acs_df_language = data_acs_2020_language_percent,
                   output_df_string = "data_combined_2018")
```


# Summarize joined data to park level

```{r}
joined_park_summary(input_df_name = data_combined_2018,
                    output_df_string = "data_combined_park_summary_2018")
```

# Saving dataframes

## Save to CSV

```{r}
# full dataset (RIDB and ACS joined)
write.csv(x = data_combined_2018, 
            file = "../../../data_clean/2018_joined_data.csv", 
            row.names = FALSE)

# dataset summarized to `park` level (RIDB and ACS joined)
write.csv(x = data_combined_park_summary_2018, 
          "../../../data_clean/2018_joined_data_site_summary.csv", 
          row.names = FALSE)
```

## Save to RDS

```{r}
# bootstrap geometries
data_combined_2018_geometry <- 
  data_combined_2018 %>% 
  st_as_sf(coords = c("facility_longitude", "facility_latitude"),
           crs = 4326)
data_combined_park_summary_2018_geometry <- 
  data_combined_park_summary_2018 %>% 
  st_as_sf(coords = c("mean_facility_longitude", "mean_facility_latitude"),
           crs = 4326)


# full dataset (RIDB and ACS joined)
saveRDS(object = data_combined_2018_geometry,
        file = "../../../data_clean/2018_joined_data.rds")

# dataset summarized to `park` level (RIDB and ACS joined)
saveRDS(object = data_combined_park_summary_2018_geometry,
        file = "../../../data_clean/2018_joined_data_site_summary.rds")
```




